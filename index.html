<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR & SRA BURGER - Sistema TPV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.18/24/solid/css/heroicons.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Firebase SDKs (opcional) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDocs, getDoc, query, where, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, linkWithCredential } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  // Support overriding config via window.FIREBASE_CONFIG, localStorage, or './firebase-config.json'
    const DEFAULT_CONFIG = {
      apiKey: "AIzaSyCPZtWKgkQORsYEP85V9mQD8tAk6gjLZwM",
      authDomain: "sr-sra-burger-tpv.firebaseapp.com",
      projectId: "sr-sra-burger-tpv",
      storageBucket: "sr-sra-burger-tpv.firebasestorage.app",
      messagingSenderId: "392520899249",
      appId: "1:392520899249:web:d5f1dd02ab1c77bb042090"
    };
    async function loadFirebaseConfig(){
      if(window.FIREBASE_CONFIG) return window.FIREBASE_CONFIG;
      try{ const ls = localStorage.getItem('FIREBASE_CONFIG'); if(ls){ const obj = JSON.parse(ls); if(obj?.apiKey) return obj; } }catch(_){ }
      // Prefer a simple JSON config file for static hosting
      try{
        const r = await fetch('./firebase-config.json', { cache:'no-store' });
        if(r.ok){ const json = await r.json(); if(json?.apiKey) return json; }
      }catch(_){ }
      return DEFAULT_CONFIG;
    }
    const firebaseConfig = await loadFirebaseConfig();

    const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  // Habilitar persistencia offline (mejor experiencia en móvil). Ignorar si el navegador no lo permite.
  try{ enableIndexedDbPersistence(db).catch(()=>{}); }catch(_){ }
    const auth = getAuth(app);

    window.db = db;
    window.auth = auth;
  // Expose config for diagnostics
  window.firebaseConfig = firebaseConfig;
  window.firebaseModules = { signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, linkWithCredential };
  window.fs = { collection, doc, setDoc, deleteDoc, onSnapshot, getDocs, getDoc, query, where };
  console.log('🔥 Firebase inicializado', { projectId: firebaseConfig?.projectId, authDomain: firebaseConfig?.authDomain });
  </script>

  <style>
  /* Brand base */
  body{ font-family: 'Poppins', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; color:var(--burger-dark) }
    :root { --burger-bun:#D4A574; --burger-meat:#8B4513; --burger-cheese:#FFD700; --burger-lettuce:#228B22; --burger-tomato:#DC143C; --burger-cream:#FFF8DC; --burger-dark:#2F1B14; --burger-light:#F5E6D3; --burger-accent:#FF6B35; }
    .view{display:none} .view.active{display:block}
  .nav-link{display:block;padding:.75rem 1rem;border-radius:.5rem;transition:background .15s ease, transform .05s ease} .nav-link:hover{background:rgba(255,255,255,.08);transform:translateX(2px)} .nav-link.active{color:#fff;background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato))}
    .loader{width:56px;height:56px;border:6px solid var(--burger-light);border-top-color:var(--burger-accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  .btn-gradient{background:linear-gradient(135deg,var(--burger-cheese),var(--burger-bun));color:var(--burger-dark);font-weight:800; border:2px solid var(--burger-bun); transition:filter .15s ease, transform .04s ease} .btn-gradient:hover{filter:brightness(1.02)} .btn-gradient:active{transform:translateY(1px)}
  .btn-success{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;font-weight:800;border:2px solid #16a34a; transition:filter .15s ease, transform .04s ease} .btn-success:hover{filter:brightness(1.03)} .btn-success:active{transform:translateY(1px)}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;font-weight:800;border:2px solid #b91c1c; transition:filter .15s ease, transform .04s ease} .btn-danger:hover{filter:brightness(1.03)} .btn-danger:active{transform:translateY(1px)}
  .btn-outline{background:#fff;border:2px solid var(--burger-bun);color:var(--burger-dark);font-weight:800; transition:background .15s ease, color .15s ease, transform .04s ease} .btn-outline:hover{background:#fff7ed} .btn-outline:active{transform:translateY(1px)}
    .input-modern{background:#fff;border:2px solid var(--burger-bun);color:var(--burger-dark)}
    .sidebar{position:relative}
    @media(max-width:1024px){
      .sidebar{position:fixed;left:-280px;top:0;bottom:0;width:280px;z-index:60;transition:left .3s;display:none}
      .sidebar.open{left:0;display:block}
    }

  /* Sections */
  .section-title{ display:flex; align-items:center; gap:.5rem; letter-spacing:.2px }
  .section-title::after{ content:''; flex:1; height:4px; border-radius:999px; margin-left:.5rem; background:linear-gradient(90deg, rgba(255,107,53,.25), rgba(212,165,116,.15)); }

  /* Cards/Panels */
  .panel{ background:linear-gradient(180deg,#ffffffee,#fff8f0ee); border:2px solid var(--burger-bun); border-radius:16px; padding:14px; box-shadow:0 10px 20px rgba(0,0,0,.05); }
  .product-card{ background:linear-gradient(180deg,#ffffff,#fff8f0); border:2px solid var(--burger-bun); border-radius:18px; box-shadow:0 10px 20px rgba(0,0,0,.06); transition:transform .06s ease, box-shadow .15s ease, border-color .15s ease; }
  .product-card:hover{ transform:translateY(-2px); box-shadow:0 16px 28px rgba(0,0,0,.1); border-color:var(--burger-accent); }

    /* Recipe list: compact, responsive */
    .recipe-title-bar{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .recipe-list{ max-height:60vh; overflow-y:auto; padding-right:.25rem; }
    .recipe-row{ display:grid; grid-template-columns: 1fr 88px 36px; gap:.5rem; align-items:center; font-size:.9rem; }
    .select-compact{ padding:.5rem .5rem; font-size:.9rem; }
    .input-compact{ padding:.5rem .5rem; font-size:.9rem; }
    .btn-compact{ padding:.375rem .5rem; font-size:.85rem; }
    @media (max-width: 480px){
      .recipe-row{ grid-template-columns: 1fr 72px 32px; font-size:.85rem; gap:.4rem; }
      .select-compact, .input-compact{ padding:.4rem .45rem; font-size:.85rem; }
      .btn-compact{ padding:.3rem .45rem; font-size:.8rem; }
    }
  /* POS: Modal de personalización bonito */
  .opt-grid{ display:grid; grid-template-columns: 1fr; gap:.75rem; }
  @media(min-width:520px){ .opt-grid{ grid-template-columns: 1fr 1fr; } }
  .opt-card{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.75rem .9rem; border:2px solid var(--burger-bun); background:#fff; border-radius:14px; cursor:pointer; transition:transform .06s ease, box-shadow .15s ease, border-color .15s ease; }
  .opt-card:hover{ border-color: var(--burger-accent); box-shadow:0 6px 18px rgba(0,0,0,.08); transform:translateY(-1px); }
  .opt-card.selected{ background:linear-gradient(135deg, rgba(16,185,129,.1), rgba(50,205,50,.08)); border-color:#10B981; }
  .opt-info{ display:flex; align-items:center; gap:.6rem; font-weight:700; color:var(--burger-dark); }
  .opt-check{ width:22px; height:22px; border:2px solid var(--burger-bun); border-radius:6px; display:inline-flex; align-items:center; justify-content:center; background:#fff; }
  .opt-card.selected .opt-check{ border-color:#10B981; background:#10B981; color:#fff; }
  .price-chip{ font-size:.85rem; font-weight:800; color:#064e3b; background:linear-gradient(135deg,#d1fae5,#a7f3d0); padding:.2rem .5rem; border-radius:999px; border:1px solid #6ee7b7; }
  .modal-header-nice{ background:linear-gradient(135deg,var(--burger-cheese),var(--burger-bun)); color:var(--burger-dark); padding:1rem 1.25rem; border-bottom:2px solid var(--burger-bun); }
  .summary-row{ display:flex; justify-content:space-between; align-items:center; padding:.25rem 0; }

  /* Clientes: UI moderno */
  .client-card{ background:linear-gradient(180deg,#fff,#fff8f0); border:2px solid var(--burger-bun); border-radius:16px; padding:14px; box-shadow:0 10px 20px rgba(0,0,0,.05); transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease; }
  .client-card:hover{ transform:translateY(-2px); box-shadow:0 16px 28px rgba(0,0,0,.08); border-color:var(--burger-accent); }
  .pill{ display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; font-size:.75rem; font-weight:800; }
  .pill-points{ background:linear-gradient(135deg,#fde68a,#f59e0b); color:#3f2d00; border:1px solid #fbbf24; }
  .pill-spend{ background:linear-gradient(135deg,#d1fae5,#6ee7b7); color:#064e3b; border:1px solid #6ee7b7; }
  .icon-btn{ width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--burger-bun); background:#fff; }
  .icon-btn:hover{ background:#fff7ed; border-color:var(--burger-accent); }
  .client-toolbar input, .client-toolbar select{ border:2px solid var(--burger-bun); }

  /* Insumos: estilos visuales */
  .insumo-badge{ font-size:.7rem; font-weight:800; padding:.15rem .4rem; border-radius:999px; border:1px solid; }
  .insumo-badge-venta{ background:#e0f2fe; color:#075985; border-color:#7dd3fc; }
  .insumo-badge-merma{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
  .stat-card{ background:linear-gradient(180deg,#fff,#fff8f0); border:2px solid var(--burger-bun); border-radius:16px; padding:14px; box-shadow:0 10px 20px rgba(0,0,0,.05); }
  .table-nice{ border-collapse: separate; border-spacing: 0; overflow: hidden; border-radius:12px; }
  .table-nice thead th{ background:#fff7ed; border-bottom:2px solid var(--burger-bun); position:sticky; top:0; z-index:1 }
  .table-nice tbody tr{ transition: background .12s ease }
  .table-nice tbody tr:nth-child(even){ background:#fffdf8 }
  .table-nice tbody tr:hover{ background:#fff4e8 }

  /* Scrollbar */
  ::-webkit-scrollbar{ width:10px; height:10px }
  ::-webkit-scrollbar-thumb{ background:linear-gradient(180deg,var(--burger-bun),#eab676); border-radius:999px; border:2px solid #fff }
  ::-webkit-scrollbar-track{ background:#fff3; }
  .kpi-trend{ font-size:.7rem; font-weight:800; padding:.1rem .4rem; border-radius:999px; border:1px solid #ddd; }
  .kpi-up{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0 }
  .kpi-down{ background:#fef2f2; color:#991b1b; border-color:#fecaca }

  /* Mobile tuning */
  @media (max-width: 640px){
    html { font-size: 14px; }
    body { line-height: 1.35; }
    .panel, .stat-card, .client-card, .product-card { padding: 10px; border-radius: 12px; }
    .section-title { font-size: 1.25rem; }
    .nav-link { padding: .5rem .75rem; }
    .table-nice thead th { font-size: .85rem; }
    .table-nice td, .table-nice th { padding: .5rem .4rem; font-size: .85rem; }
    .kpi-trend { font-size: .6rem; }
    #sales-hourly-chart { height: 120px !important; }
    #pos-order-items { max-height: 55vh !important; }
    .opt-card { padding: .6rem .7rem; }
    .price-chip { font-size: .75rem; }
    .icon-btn { width: 28px; height: 28px; }
    .pill { font-size: .7rem; }
    .input-modern { padding: .45rem .55rem; }
    #pos-product-list { gap: .75rem; }
  /* Mobile: 3-column square tiles for POS product grid */
  #pos-product-list{ grid-template-columns: repeat(3, minmax(0, 1fr)) !important; gap: .5rem; }
  #pos-product-list .product-card{ aspect-ratio: 1/1; min-height: 110px; padding:.6rem; border:2px solid var(--burger-bun); border-radius:.75rem; background:#fff; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; }
  #pos-product-list .product-card .prod-desc{ display:none; }
  #pos-product-list .product-card .prod-name{ font-size:.9rem; line-height:1.1rem; font-weight:800; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  #pos-product-list .product-card .btn-add-to-order{ padding:.35rem .5rem; font-size:.75rem; }
  #pos-product-list .product-card .text-lg{ font-size: .95rem; }
    .loader { width: 44px; height: 44px; border-width: 5px; }
  }
  </style>
</head>
<body class="font-sans min-h-screen" style="background:linear-gradient(135deg,#F5E6D3 0%,#FFF8DC 50%,#D4A574 100%);background-attachment:fixed">
  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 z-[100] flex flex-col justify-center items-center" style="background:linear-gradient(135deg,var(--burger-cream),var(--burger-light))">
    <div class="loader"></div>
    <p class="mt-4 font-bold" style="color:var(--burger-dark)">Cargando TPV...</p>
  </div>

  <div class="flex h-screen">
  <!-- Backdrop for mobile sidebar -->
  <div id="sidebar-backdrop" class="hidden fixed inset-0 z-50 bg-black/40 lg:hidden"></div>
    <!-- Botón flotante menú móvil -->
    <button id="mobile-menu-btn" aria-label="Abrir menú" class="fixed bottom-4 left-4 lg:hidden z-[70] rounded-full shadow-lg"
      style="background:linear-gradient(135deg,var(--burger-accent),var(--burger-tomato)); color:#fff; width:56px; height:56px; display:flex; align-items:center; justify-content:center; border:3px solid rgba(255,255,255,.6);">
      ☰
    </button>

    <!-- Sidebar -->
  <aside class="sidebar w-72 text-white flex flex-col flex-shrink-0 lg:block" style="background:linear-gradient(180deg,var(--burger-meat) 0%,var(--burger-dark) 100%);border-right:3px solid var(--burger-bun)">
      <div class="p-6 border-b border-white/20">
        <div class="text-3xl">🍔</div>
        <h1 class="text-xl font-bold">SR & SRA BURGER</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="#dashboard" class="nav-link active">📊 Dashboard</a>
        <a href="#reportes" class="nav-link">📈 Reportes</a>
        <a href="#vender" class="nav-link">🛒 Punto de Venta</a>
        <a href="#pedidos-pendientes" class="nav-link">👨‍🍳 Pedidos</a>
        <a href="#ventas" class="nav-link">🧾 Ventas</a>
        <a href="#productos" class="nav-link">🍔 Productos</a>
  <a href="#ingredientes" class="nav-link">🥬 Ingredientes</a>
  <a href="#insumos" class="nav-link">📦 Insumos Gastados</a>
  <a href="#inventario" class="nav-link">🗃️ Inventario</a>
  <a href="#clientes" class="nav-link">👥 Clientes</a>
      </nav>
      <div class="p-4 border-t border-white/20 text-xs">
        <div class="opacity-80">ID Sesión:</div>
        <div id="user-id-display" class="break-all font-mono"></div>
        <div class="mt-3 space-y-2">
          <div class="opacity-80">Respaldo</div>
          <button id="btn-backup" class="w-full px-3 py-2 rounded bg-white/10 hover:bg-white/20 border border-white/30 text-white text-sm">📤 Respaldar datos</button>
          <button id="btn-restore" class="w-full px-3 py-2 rounded bg-white/10 hover:bg-white/20 border border-white/30 text-white text-sm">📥 Restaurar</button>
          <input id="restore-file-input" type="file" accept="application/json" class="hidden" />
          <div class="opacity-80 mt-3">Proyecto Firebase</div>
          <div id="firebase-project-indicator" class="text-[10px] opacity-70 break-all"></div>
          <div id="auth-controls" class="mt-3">
            <div class="opacity-80 mb-1">Sesión</div>
            <input id="auth-email" type="email" placeholder="Email" class="w-full px-2 py-1 rounded bg-white/10 border border-white/30 text-white/90 placeholder-white/60" />
            <input id="auth-pass" type="password" placeholder="Contraseña" class="w-full mt-2 px-2 py-1 rounded bg-white/10 border border-white/30 text-white/90 placeholder-white/60" />
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btn-login" class="px-2 py-2 rounded bg-white/10 hover:bg-white/20 border border-white/30 text-white text-sm">Iniciar</button>
              <button id="btn-signup" class="px-2 py-2 rounded bg-white/10 hover:bg-white/20 border border-white/30 text-white text-sm">Crear cuenta</button>
            </div>
          </div>
          <div id="auth-status-card" class="hidden mt-3 rounded-xl border border-white/30 bg-white/10 p-3 text-white">
            <div class="flex items-center justify-between gap-2">
              <div class="font-extrabold tracking-wide" style="letter-spacing:.3px">✅ SESIÓN INICIADA</div>
              <button id="btn-logout" class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 border border-white/30 text-white text-xs">Cerrar sesión</button>
            </div>
            <div class="mt-2 text-sm opacity-90">
              <div class="flex items-center gap-2"><span class="opacity-80">Correo:</span> <span id="auth-status-email" class="font-semibold break-all"></span></div>
              <div class="flex items-center gap-2"><span class="opacity-80">UID:</span> <span id="auth-status-uid" class="font-mono text-xs"></span></div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
  <main class="flex-1 p-3 overflow-y-auto">
      <!-- Dashboard -->
      <section id="view-dashboard" class="view active">
        <h2 class="text-2xl font-extrabold mb-4 section-title" style="color:var(--burger-dark)">📊 Dashboard</h2>
        <div class="flex items-center justify-between gap-3 mb-4">
          <div class="text-sm opacity-80">Vista del negocio de SR & SRA BURGER</div>
          <div class="flex items-center gap-2">
            <label class="text-sm font-bold">Periodo</label>
            <select id="db-period-select" class="input-modern p-2 rounded">
              <option value="7d">Últimos 7 días</option>
              <option value="today">Hoy</option>
              <option value="30d">Últimos 30 días</option>
              <option value="month">Este mes</option>
              <option value="all">Todo</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">Ingresos</div><div id="kpi-revenue-trend" class="kpi-trend"></div></div>
            <div id="kpi-revenue" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">Órdenes</div><div id="kpi-orders-trend" class="kpi-trend"></div></div>
            <div id="kpi-orders" class="text-3xl font-extrabold">0</div>
          </div>
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">Ticket promedio</div><div id="kpi-aov-trend" class="kpi-trend"></div></div>
            <div id="kpi-aov" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="flex items-center justify-between"><div class="text-sm opacity-80">Items vendidos</div><div id="kpi-items-trend" class="kpi-trend"></div></div>
            <div id="kpi-items" class="text-3xl font-extrabold">0</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Descuento aplicado</div>
            <div id="kpi-discount" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Envío cobrado</div>
            <div id="kpi-shipping" class="text-3xl font-extrabold">$0.00</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Mejor producto</div>
            <div id="kpi-top-product" class="text-lg font-extrabold">—</div>
          </div>
          <div class="panel">
            <div class="text-sm opacity-80">Mejor cliente</div>
            <div id="kpi-top-client" class="text-lg font-extrabold">—</div>
          </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-4">
          <div class="panel xl:col-span-2">
            <h3 class="font-bold mb-2">Ventas recientes</h3>
            <table class="w-full text-left table-nice"><thead><tr><th class="p-2">ID</th><th class="p-2">Cliente</th><th class="p-2">Fecha</th><th class="p-2 text-right">Total</th></tr></thead><tbody id="db-ventas-recientes-body"></tbody></table>
          </div>
          <div class="panel">
            <h3 class="font-bold mb-2">Ventas por hora (hoy)</h3>
            <canvas id="sales-hourly-chart" height="150"></canvas>
            <div id="sales-hourly-empty" class="text-sm opacity-60 hidden">Sin datos de hoy</div>
          </div>
        </div>
      </section>

      <!-- Reportes -->
      <section id="view-reportes" class="view">
        <h2 class="text-2xl font-extrabold mb-4 section-title" style="color:var(--burger-dark)">📈 Reportes</h2>
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3 mb-4">
          <div class="text-sm opacity-80">Análisis visual de desempeño</div>
          <div class="flex flex-col md:flex-row md:items-center gap-2">
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Periodo</label>
              <select id="rep-period-select" class="input-modern p-2 rounded">
                <option value="7d">Últimos 7 días</option>
                <option value="today">Hoy</option>
                <option value="30d">Últimos 30 días</option>
                <option value="month">Este mes</option>
                <option value="all">Todo</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div id="rep-custom-range" class="flex items-center gap-2 hidden">
              <input id="rep-date-start" type="date" class="input-modern p-2 rounded" />
              <span class="opacity-60">a</span>
              <input id="rep-date-end" type="date" class="input-modern p-2 rounded" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Tipo</label>
              <select id="rep-filter-type" class="input-modern p-2 rounded">
                <option value="all">Todos</option>
                <option value="local">Local</option>
                <option value="para_llevar">Para llevar</option>
                <option value="envio">Envío</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-bold">Pago</label>
              <select id="rep-filter-pay" class="input-modern p-2 rounded">
                <option value="all">Todos</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div class="flex items-center gap-2 ml-auto">
              <button id="rep-export-sales" class="btn-outline px-3 py-2 rounded text-sm">Exportar ventas CSV</button>
              <button id="rep-export-products" class="btn-outline px-3 py-2 rounded text-sm">Exportar productos CSV</button>
              <button id="rep-export-summary" class="btn-outline px-3 py-2 rounded text-sm">Resumen CSV</button>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mb-4">
          <div class="stat-card"><div class="text-xs opacity-70">Ingresos</div><div id="rep-revenue" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Órdenes</div><div id="rep-orders" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Ticket promedio</div><div id="rep-aov" class="text-xl font-extrabold">$0.00</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Margen bruto (est.)</div><div id="rep-gp" class="text-xl font-extrabold">$0.00</div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <div class="panel"><h3 class="font-bold mb-2">Ventas por período</h3><canvas id="sales-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">Productos más vendidos</h3><canvas id="products-chart"></canvas></div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-4">
          <div class="panel"><h3 class="font-bold mb-2">Tipos de orden</h3><canvas id="order-type-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">Métodos de pago</h3><canvas id="payment-method-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">Por día de la semana</h3><canvas id="weekday-chart"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <div class="panel"><h3 class="font-bold mb-2">Top clientes</h3><canvas id="top-clients-chart"></canvas></div>
          <div class="panel"><h3 class="font-bold mb-2">Margen por producto (Top 10)</h3><canvas id="margin-chart"></canvas></div>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div class="panel"><h3 class="font-bold mb-2">Ingresos por hora</h3><canvas id="hourly-report-chart"></canvas></div>
        </div>
      </section>

      <!-- POS -->
      <section id="view-vender" class="view">
        <h2 class="text-2xl font-extrabold mb-2 section-title" style="color:var(--burger-dark)">🛒 Punto de Venta</h2>
        <div class="flex flex-col lg:flex-row gap-4">
          <div class="lg:w-2/3">
            <div class="flex flex-col sm:flex-row sm:items-end gap-3 mb-3">
              <div class="flex-1">
                <label class="block text-sm font-bold mb-1">Buscar</label>
                <input id="pos-search-input" type="text" class="w-full input-modern p-2 rounded" placeholder="Busca por nombre...">
              </div>
              <div>
                <label class="block text-sm font-bold mb-1">Tipo de orden</label>
                <select id="pos-order-type" class="input-modern p-2 rounded">
                  <option value="local">Local</option>
                  <option value="para_llevar">Para llevar</option>
                  <option value="envio">Envío</option>
                </select>
              </div>
            </div>
            <div class="mb-2 flex flex-wrap gap-2 text-sm">
              <button class="pos-cat-btn px-3 py-1 rounded border bg-white" data-pos-cat="all">Todo</button>
              <button class="pos-cat-btn px-3 py-1 rounded border" data-pos-cat="Hamburguesas">Hamburguesas</button>
              <button class="pos-cat-btn px-3 py-1 rounded border" data-pos-cat="Hotdogs">Hotdogs</button>
              <button class="pos-cat-btn px-3 py-1 rounded border" data-pos-cat="Complementos">Complementos</button>
              <button class="pos-cat-btn px-3 py-1 rounded border" data-pos-cat="Postres">Postres</button>
              <button class="pos-cat-btn px-3 py-1 rounded border" data-pos-cat="Bebidas">Bebidas</button>
            </div>
            <div id="pos-product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </div>
          <div class="lg:w-1/3 panel">
            <div class="flex items-center mb-4"><span class="mr-2">🧾</span><h3 class="font-bold">Orden Actual</h3></div>
            <div id="pos-order-items" class="space-y-3 mb-4 max-h-80 overflow-y-auto"><div class="text-center py-6 text-sm opacity-70">Añade productos para empezar</div></div>
            <div class="space-y-3 border-t pt-3">
              <div class="flex justify-between text-lg"><span>Subtotal</span><span id="pos-subtotal" class="font-bold">$0.00</span></div>
              <div>
                <div class="flex justify-between items-center mb-1"><label for="pos-discount-input">Descuento</label><input type="number" id="pos-discount-input" class="w-28 input-modern p-2 rounded text-right" placeholder="0.00" min="0"></div>
                <div class="flex gap-2">
                  <button class="px-2 py-1 rounded border text-xs" data-discount-pct="5">5%</button>
                  <button class="px-2 py-1 rounded border text-xs" data-discount-pct="10">10%</button>
                  <button class="px-2 py-1 rounded border text-xs" data-discount-pct="15">15%</button>
                </div>
              </div>
              <div class="flex justify-between items-center"><label class="flex items-center gap-2"><input type="checkbox" id="pos-shipping-checkbox"><span>Envío</span></label><input type="number" id="pos-shipping-cost" class="w-28 input-modern p-2 rounded text-right hidden" placeholder="0.00" min="0"></div>
              <div class="flex justify-between text-2xl font-bold border-t pt-2"><span>Total</span><span id="pos-total">$0.00</span></div>
              <div>
                <label for="pos-customer-select" class="block text-sm font-bold mb-1">Cliente</label>
                <div class="flex gap-2">
                  <select id="pos-customer-select" class="flex-1 input-modern p-2 rounded"></select>
                  <button id="pos-add-customer" class="px-3 py-2 rounded border" title="Nuevo cliente">➕</button>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <button id="pos-suspend-btn" class="btn-outline px-3 py-2 rounded">Suspender</button>
                <button id="pos-clear-btn" class="btn-outline px-3 py-2 rounded">Vaciar</button>
                <button id="pos-suspended-list-btn" class="btn-outline px-3 py-2 rounded col-span-1">Guardados</button>
                <button id="pos-pay-btn" class="btn-success py-2 rounded col-span-1 disabled:opacity-50" disabled>Cobrar</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Pedidos -->
      <section id="view-pedidos-pendientes" class="view">
        <h2 class="text-2xl font-bold mb-4" style="color:var(--burger-dark)">Pedidos Pendientes</h2>
  <div class="panel">
          <div class="mb-3 text-sm opacity-70">En cola: <span id="pedidos-count">0</span></div>
          <div id="pedidos-pendientes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="no-pedidos-message" class="text-center py-8 opacity-70 hidden">No hay pedidos pendientes</div>
        </div>
      </section>

      <!-- Ventas -->
      <section id="view-ventas" class="view">
        <h2 class="text-2xl font-bold mb-4" style="color:var(--burger-dark)">Historial de Ventas</h2>
        <div class="panel overflow-x-auto">
          <table class="w-full text-left"><thead><tr><th class="p-2">ID</th><th class="p-2">Fecha</th><th class="p-2">Cliente</th><th class="p-2">Items</th><th class="p-2 text-right">Total</th><th class="p-2">Acciones</th></tr></thead><tbody id="ventas-list-body"></tbody></table>
        </div>
      </section>

      <!-- Productos -->
      <section id="view-productos" class="view">
        <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold" style="color:var(--burger-dark)">Gestión de Productos</h2><div class="flex gap-2"><button id="open-productos-modal" class="btn-gradient px-4 py-2 rounded">➕ Crear Producto</button><button id="import-producto-btn" class="px-3 py-2 rounded border" title="Importar desde texto">📥 Importar</button></div></div>
  <div class="panel overflow-x-auto">
          <table class="w-full text-left"><thead><tr><th class="p-2">Nombre</th><th class="p-2">Precio</th><th class="p-2">Costo</th><th class="p-2">Margen</th><th class="p-2">Descripción</th><th class="p-2">Acciones</th></tr></thead><tbody id="productos-list-body"></tbody></table>
        </div>
      </section>

      <!-- Ingredientes -->
      <section id="view-ingredientes" class="view">
        <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold" style="color:var(--burger-dark)">Gestión de Ingredientes</h2><div class="flex gap-2"><button id="open-ingredientes-modal" class="btn-gradient px-4 py-2 rounded">➕ Añadir Ingrediente</button><button id="import-ingredientes-preset" class="px-3 py-2 rounded border" title="Importar lista predefinida">📥 Importar</button></div></div>
  <div class="panel overflow-x-auto">
          <table class="w-full text-left"><thead><tr><th class="p-2">Nombre</th><th class="p-2">Unidad</th><th class="p-2">Precio Paquete</th><th class="p-2">Unidades/Paquete</th><th class="p-2">Acciones</th></tr></thead><tbody id="ingredientes-list-body"></tbody></table>
        </div>
      </section>

      <!-- Insumos Gastados (debajo de Ingredientes) -->
      <section id="view-insumos" class="view">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">📦 Insumos Gastados</h2>
          <div class="flex gap-2">
            <button id="insumos-recompute" class="btn-outline px-3 py-2 rounded" title="Recalcular desde ventas">↻ Recalcular</button>
            <button id="insumos-clear" class="btn-outline px-3 py-2 rounded" title="Limpiar historial">🧹 Limpiar</button>
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <div class="stat-card"><div class="text-xs opacity-70">Ingredientes</div><div id="ins-stat-ings" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Líneas de historial</div><div id="ins-stat-lines" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Mermas</div><div id="ins-stat-mermas" class="text-xl font-extrabold">0</div></div>
          <div class="stat-card"><div class="text-xs opacity-70">Ventas registradas</div><div id="ins-stat-ventas" class="text-xl font-extrabold">0</div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="panel overflow-x-auto">
            <h3 class="font-bold mb-2">Totales consumidos</h3>
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Ingrediente</th><th class="p-2">Unidad</th><th class="p-2 text-right">Cantidad</th><th class="p-2">Acciones</th></tr></thead>
              <tbody id="insumos-totales-body"></tbody>
            </table>
          </div>
          <div class="panel overflow-x-auto">
            <h3 class="font-bold mb-2">Ventas (consumo)</h3>
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Fecha</th><th class="p-2">Venta</th><th class="p-2">Detalle</th></tr></thead>
              <tbody id="insumos-ventas-body"></tbody>
            </table>
          </div>
          <div class="panel overflow-x-auto">
            <h3 class="font-bold mb-2">Mermas</h3>
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Fecha</th><th class="p-2">Ingrediente</th><th class="p-2">Cantidad</th></tr></thead>
              <tbody id="insumos-mermas-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Inventario (debajo de Insumos) -->
      <section id="view-inventario" class="view">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">🗃️ Stock de Ingredientes</h2>
          <div class="text-sm opacity-70">Registra compras y controla existencias</div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="panel overflow-x-auto lg:col-span-2">
            <h3 class="font-bold mb-2">Stock actual</h3>
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Ingrediente</th><th class="p-2">Unidad</th><th class="p-2 text-right">Comprado (unid)</th><th class="p-2 text-right">Consumido+Merma</th><th class="p-2 text-right">Disponible</th><th class="p-2">Acciones</th></tr></thead>
              <tbody id="inv-stock-body"></tbody>
            </table>
          </div>
          <div class="panel overflow-x-auto">
            <h3 class="font-bold mb-2">Historial de compras</h3>
            <table class="w-full text-left table-nice">
              <thead><tr><th class="p-2">Fecha</th><th class="p-2">Ingrediente</th><th class="p-2 text-right">Piezas</th><th class="p-2 text-right">Unidades</th><th class="p-2 text-right">Costo</th></tr></thead>
              <tbody id="inv-compras-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Clientes -->
      <section id="view-clientes" class="view">
        <div class="flex flex-col gap-3 mb-4">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-extrabold section-title" style="color:var(--burger-dark)">👥 Gestión de Clientes</h2>
            <div class="flex gap-2">
              <button id="open-clientes-modal" class="btn-gradient px-4 py-2 rounded">➕ Nuevo Cliente</button>
              <button id="import-clientes-preset" class="btn-outline px-3 py-2 rounded">📥 Importar Clientes</button>
            </div>
          </div>
          <div class="client-toolbar grid grid-cols-1 md:grid-cols-3 gap-2">
            <div>
              <label class="block text-sm font-bold mb-1">Buscar cliente</label>
              <input id="clientes-search" type="text" class="w-full input-modern p-2 rounded" placeholder="Nombre, teléfono o dirección" />
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Ordenar por</label>
              <select id="clientes-sort" class="w-full input-modern p-2 rounded">
                <option value="nombre">Nombre (A-Z)</option>
                <option value="puntos">Puntos (desc)</option>
                <option value="gasto">Gasto total (desc)</option>
                <option value="reciente">Más reciente</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button id="clientes-view-cards" class="px-3 py-2 rounded border bg-white">Tarjetas</button>
              <button id="clientes-view-table" class="px-3 py-2 rounded border">Tabla</button>
            </div>
          </div>
        </div>
  <div class="panel">
          <div id="clientes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="clientes-table-wrapper" class="overflow-x-auto hidden mt-2">
            <table class="w-full text-left"><thead><tr><th class="p-2">Nombre</th><th class="p-2">Teléfono</th><th class="p-2">Dirección</th><th class="p-2">Gasto Total</th><th class="p-2">Puntos</th><th class="p-2">Acciones</th></tr></thead><tbody id="clientes-list-body"></tbody></table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modales básicos -->
  <div id="modal-backdrop" class="fixed inset-0 backdrop-blur-sm hidden z-40" style="background:rgba(0,0,0,.5)"></div>
  <div id="modal-container" class="fixed inset-0 hidden z-50 flex items-center justify-center p-6"></div>

  <script>
    // Estado global
  let appState = { ingredientes: [], productos: [], clientes: [], ventas: [], pedidosPendientes: [], insumosConsumo: { totales:{}, historial:[], merma:[] }, inventario:{ compras:[] }, nextSaleNumber: 1 };
  let currentOrder = { items: [], clienteId: null, subtotal: 0, total: 0, descuento: 0, costoEnvio: 0, tipo:'local', pago:null };
  let posCategoryFilter = 'all';
  let suspendedOrders = [];

    // Utilidades
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const fmt = (n)=>'$'+(Number(n)||0).toFixed(2);
    const hideLoading = ()=>{ const el=$('#loading-overlay'); if(el){ el.style.display='none'; el.style.pointerEvents='none'; } };
    const saveLS = ()=> localStorage.setItem('sr-sra-burger-data', JSON.stringify(appState));
    const loadLS = ()=>{ try{ const s=localStorage.getItem('sr-sra-burger-data'); if(s) appState = { ...appState, ...JSON.parse(s) }; }catch(e){ console.warn('localStorage', e); } };

    function sanitizeState(){
      // Asegurar arrays y quitar entradas inválidas que rompen render/acciones
      if(!Array.isArray(appState.ingredientes)) appState.ingredientes = [];
      if(!Array.isArray(appState.productos)) appState.productos = [];
      if(!Array.isArray(appState.clientes)) appState.clientes = [];
      if(!Array.isArray(appState.ventas)) appState.ventas = [];
      if(!Array.isArray(appState.pedidosPendientes)) appState.pedidosPendientes = [];
  if(!appState.insumosConsumo) appState.insumosConsumo = { totales:{}, historial:[], merma:[] };
  if(!appState.insumosConsumo.merma) appState.insumosConsumo.merma = [];
  if(!appState.inventario) appState.inventario = { compras:[] };
  if(!Array.isArray(appState.inventario.compras)) appState.inventario.compras = [];
  if(!Array.isArray(appState.insumosConsumo.merma)) appState.insumosConsumo.merma = [];
      appState.ingredientes = appState.ingredientes.filter(i=> i && typeof i === 'object' && i.nombre);
      if(typeof appState.nextSaleNumber !== 'number' || appState.nextSaleNumber < 1){ appState.nextSaleNumber = 1; }
    }

    // --- Inventario ---
    function unitsPerPiece(ing){
      const up = Number(ing?.unidadesPaquete)||0; return up>0? up: 1;
    }
    function computeStock(){
      // Map ingredientId -> { compradoUnidades, comprasPiezas }
      const stock = {};
      (appState.inventario.compras||[]).forEach(c=>{
        const unid = Number(c.piezas||0) * unitsPerPiece(getIngredientById(c.ingredienteId));
        if(!stock[c.ingredienteId]) stock[c.ingredienteId] = { compradoUnidades:0, comprasPiezas:0 };
        stock[c.ingredienteId].compradoUnidades += unid;
        stock[c.ingredienteId].comprasPiezas += Number(c.piezas||0);
      });
      return stock;
    }
    function renderInventario(){
      const sb = document.getElementById('inv-stock-body');
      const hb = document.getElementById('inv-compras-body');
      if(!sb || !hb) return;
      sb.innerHTML=''; hb.innerHTML='';
      const stock = computeStock();
      const totales = appState.insumosConsumo?.totales||{};
      const merma = appState.insumosConsumo?.merma||[];
      const mermaByIng = {};
      merma.forEach(m=>{ mermaByIng[m.ingredienteId] = (mermaByIng[m.ingredienteId]||0) + Number(m.cantidad||0); });
      (appState.ingredientes||[]).forEach(ing=>{
        const unidPorPza = unitsPerPiece(ing);
        const compradoUnid = stock[ing.id]?.compradoUnidades||0;
        const consumido = Number(totales[ing.id]||0) + Number(mermaByIng[ing.id]||0);
        const disponible = Math.max(0, compradoUnid - consumido);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${ing.nombre}</td>
          <td class="p-2">${ing.unidad||''}</td>
          <td class="p-2 text-right">${(stock[ing.id]?.compradoUnidades||0).toFixed(2)}</td>
          <td class="p-2 text-right">${consumido.toFixed(2)}</td>
          <td class="p-2 text-right font-bold">${disponible.toFixed(2)}</td>
          <td class="p-2"><button class="px-2 py-1 rounded border text-sm btn-add-compra" data-id="${ing.id}">Agregar compra</button></td>`;
        sb.appendChild(tr);
      });
      // Historial compras
      const compras = (appState.inventario.compras||[]).slice().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      if(compras.length===0){ hb.innerHTML='<tr><td colspan="5" class="p-3 text-center opacity-60">Sin compras registradas</td></tr>'; }
      else compras.forEach(c=>{
        const ing = getIngredientById(c.ingredienteId);
        const unid = Number(c.piezas||0) * unitsPerPiece(ing);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2">${new Date(c.fecha).toLocaleString()}</td><td class="p-2">${ing?ing.nombre:'—'}</td><td class="p-2 text-right">${c.piezas||0}</td><td class="p-2 text-right">${unid}</td><td class="p-2 text-right">${fmt(c.costo||0)}</td>`;
        hb.appendChild(tr);
      });
    }

    // Wire: botón Agregar compra
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest && e.target.closest('.btn-add-compra');
      if(!btn) return;
      const ingId = btn.getAttribute('data-id');
      const ing = getIngredientById(ingId);
      if(!ing) return;
      openFormModal({
        title:`Agregar compra: ${ing.nombre}`,
        fields:[
          { name:'piezas', label:`Piezas (1 pieza = ${unitsPerPiece(ing)} ${ing.unidad||'unid'})`, type:'number', min:1, step:'1' },
          { name:'costo', label:'Costo total ($)', type:'number', min:0, step:'0.01' },
          { name:'nota', label:'Nota (opcional)', type:'text' }
        ],
        submitText:'Registrar',
        onSubmit:(data)=>{
          const piezas = Math.max(0, Number(data.piezas||0));
          const costo = Math.max(0, Number(data.costo||0));
          if(piezas<=0){ alert('Ingresa piezas > 0'); return false; }
          const compra = { id: generateId('cmp'), ingredienteId: ingId, piezas, costo, nota:(data.nota||'').trim(), fecha: new Date().toISOString() };
          appState.inventario.compras.push(compra);
          if(typeof saveCompraToFirestore==='function') saveCompraToFirestore(compra);
          saveLS();
          renderInventario();
        }
      });
    });
    // Asegurar numeración secuencial de ventas (Venta1, Venta2, ...)
    function assignSaleNumbersIfMissing(){
      try{
        const ventas = Array.isArray(appState.ventas) ? appState.ventas : [];
        const missing = ventas.some(v=> typeof v.saleNumber !== 'number' || v.saleNumber < 1);
        if(!missing){
          const maxNum = ventas.reduce((m,v)=> Math.max(m, v.saleNumber||0), 0);
          appState.nextSaleNumber = Math.max(appState.nextSaleNumber||1, maxNum+1);
          return;
        }
        const ordered = ventas.slice().sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
        let n = 1;
        ordered.forEach(v=>{ v.saleNumber = n++; });
        appState.nextSaleNumber = n;
      }catch(e){ console.warn('assignSaleNumbersIfMissing', e); }
    }

    // --- Modales básicos ---
    function closeModal(){ const b=$('#modal-backdrop'); const c=$('#modal-container'); if(!b||!c) return; b.classList.add('hidden'); c.classList.add('hidden'); c.innerHTML=''; }
    function generateId(prefix){ return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2,6)}`; }
    function openFormModal({ title, fields, onSubmit, submitText='Guardar' }){
      let backdrop = $('#modal-backdrop');
      let container = $('#modal-container');
      // Crear si no existen
      if(!backdrop){ backdrop = document.createElement('div'); backdrop.id='modal-backdrop'; backdrop.className='fixed inset-0 backdrop-blur-sm hidden z-40'; backdrop.style.background='rgba(0,0,0,.5)'; document.body.appendChild(backdrop); }
      if(!container){ container = document.createElement('div'); container.id='modal-container'; container.className='fixed inset-0 hidden z-50 flex items-center justify-center p-6'; document.body.appendChild(container); }
      const body = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
          <h3 class="text-lg font-bold mb-4" style="color:var(--burger-dark)">${title}</h3>
          <form id="dynamic-form" class="space-y-3">
            ${fields.map(f=>{
              if(f.type==='textarea'){
                return `<div><label class="block text-sm font-bold mb-1">${f.label}</label><textarea name="${f.name}" rows="${f.rows||3}" class="w-full input-modern p-2 rounded" placeholder="${f.placeholder||''}">${f.value||''}</textarea></div>`;
              }
              return `<div><label class="block text-sm font-bold mb-1">${f.label}</label><input type="${f.type||'text'}" name="${f.name}" class="w-full input-modern p-2 rounded" placeholder="${f.placeholder||''}" value="${f.value||''}" ${f.min!=null?`min="${f.min}"`:''} ${f.step?`step="${f.step}"`:''}></div>`;
            }).join('')}
            <div class="flex gap-2 pt-2">
              <button type="submit" class="btn-success px-4 py-2 rounded">${submitText}</button>
              <button type="button" class="btn-danger px-4 py-2 rounded" id="cancel-modal-btn">Cancelar</button>
            </div>
          </form>
        </div>`;
      container.innerHTML = body;
      backdrop.classList.remove('hidden');
      container.classList.remove('hidden');
      $('#cancel-modal-btn')?.addEventListener('click', closeModal);
      $('#dynamic-form')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        fields.forEach(f=>{ if(f.type==='number') data[f.name] = parseFloat(data[f.name]||'0'); });
        try{
          const res = onSubmit?.(data);
          if(res === false){ return; }
        }catch(err){ console.warn('modal submit', err); }
        closeModal();
      });
    }

    // --- Helpers de costos/recetas ---
    function getIngredientById(id){ return appState.ingredientes.find(i=>i.id===id); }
    function getUnitCost(ing){ if(!ing) return 0; const up=Number(ing.unidadesPaquete)||0; const pp=Number(ing.precioPaquete)||0; return up>0? pp/up : 0; }
    // Costo total de una receta (array de { ingredienteId, cantidad })
    function computeRecipeCost(receta){
      try{
        if(!Array.isArray(receta)) return 0;
        let total = 0;
        for(const r of receta){
          const ing = getIngredientById(r.ingredienteId);
          const qty = Number(r.cantidad)||0;
          if(ing && qty>0){ total += getUnitCost(ing) * qty; }
        }
        return total;
      }catch(e){ console.warn('computeRecipeCost', e); return 0; }
    }

    // --- Firestore: sincronización de productos ---
    let unsubscribeProducts = null;
    // Marca si ya recibimos al menos una sincronización desde Firestore para evitar crear duplicados antes de tiempo
    window.__productsSynced = window.__productsSynced || false;

    // Normaliza nombres para comparaciones (evita duplicados por mayúsculas/espacios)
    function normalizeName(s){ return (s||'').toString().trim().toLowerCase(); }
    // Elige un único producto por nombre normalizado; prioriza no archivado y con receta/costos definidos
    function uniqueByProductName(list){
      try{
        const pickScore = (p)=>{
          let s = 0;
          if(p?.archivado) s -= 1000;
          if(Array.isArray(p?.receta) && p.receta.length>0) s += 10;
          if(Number(p?.costo)>0) s += 5;
          if(Number(p?.precio)>0) s += 1;
          return s;
        };
        const best = new Map();
        (Array.isArray(list)?list:[]).forEach(p=>{
          const key = normalizeName(p?.nombre);
          if(!key){ return; }
          const curr = best.get(key);
          if(!curr || pickScore(p) > pickScore(curr)) best.set(key, p);
        });
        return Array.from(best.values());
      }catch(_){ return Array.isArray(list)?list:[]; }
    }
    // Lista visible sin duplicados (por nombre) y no archivados
    function getVisibleProducts(){ return uniqueByProductName(appState.productos||[]).filter(p=> !p.archivado); }
  let unsubscribeIngredientes = null;
  let unsubscribeClientes = null;
  let unsubscribeVentas = null;
  let unsubscribeCompras = null;
  let unsubscribeInsumos = null; // one doc per user
  let unsubscribePedidos = null;
  let unsubscribeMeta = null;
    function isFirestoreReady(){ return !!(window.db && window.fs); }
  async function saveProductToFirestore(prod){
      try{
    if(!isFirestoreReady() || !prod?.id) return;
    const uid = window.auth?.currentUser?.uid;
    if(!uid) return;
    const { doc, setDoc } = window.fs;
    await setDoc(doc(window.db, 'productos', prod.id), { ...prod, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveProductToFirestore', e); }
    }
    async function deleteProductFromFirestore(id){
      // Soft-archive instead of hard delete to avoid re-seeding and rule issues
      try{
        if(!isFirestoreReady() || !id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'productos', id), { archivado:true, archivedAt:new Date().toISOString(), userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] deleteProductFromFirestore(archive)', e); }
    }
  function subscribeProducts(){
      try{
    if(!isFirestoreReady()) return;
        if(unsubscribeProducts){ return; }
    const uid = window.auth?.currentUser?.uid;
    if(!uid) return;
    const { collection, onSnapshot, query, where } = window.fs;
    const colRef = collection(window.db, 'productos');
    const q = query(colRef, where('userId','==', uid));
  unsubscribeProducts = onSnapshot(q, (snap)=>{
          if(snap.empty){
            console.info('[FS] productos vacíos en Firestore; conservando locales y haciendo bootstrap…');
            // Empujar locales a Firestore si corresponde
            try{ maybeBootstrapProductsToFirestore(); }catch(_){ }
            // No sobrescribir appState.productos aquí para no perder locales
            return;
          }
      const arr = [];
      snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
      const deduped = uniqueByProductName(arr);
      appState.productos = deduped;
      // Marcamos que ya tenemos una primera sync para permitir seeding seguro sin crear duplicados
      window.__productsSynced = true;
          saveLS();
          renderAll();
          renderPosProductList();
        }, (err)=> console.warn('[FS] subscribeProducts', err));
      }catch(e){ console.warn('[FS] subscribeProducts(outside)', e); }
    }
  async function maybeBootstrapProductsToFirestore(){
      try{
    if(!isFirestoreReady()) return;
    const uid = window.auth?.currentUser?.uid;
    if(!uid) return;
    const { collection, getDocs, doc, setDoc, query, where } = window.fs;
    const colRef = collection(window.db, 'productos');
    const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.productos) && appState.productos.length>0){
          for(const p of appState.productos){
      await setDoc(doc(window.db, 'productos', p.id), { ...p, userId: uid }, { merge:true });
          }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapProductsToFirestore', e); }
    }
    function startFirestoreProductSync(){
      subscribeProducts();
      // bootstrapping en segundo plano
      maybeBootstrapProductsToFirestore();
    }

    // --- Firestore: Ingredientes ---
    async function saveIngredientToFirestore(ing){
      try{
        if(!isFirestoreReady() || !ing?.id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'ingredientes', ing.id), { ...ing, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveIngredientToFirestore', e); }
    }
    async function deleteIngredientFromFirestore(id){
      try{
        if(!isFirestoreReady() || !id) return;
        const { doc, deleteDoc } = window.fs;
        await deleteDoc(doc(window.db, 'ingredientes', id));
      }catch(e){ console.warn('[FS] deleteIngredientFromFirestore', e); }
    }
    function subscribeIngredientes(){
      try{
        if(!isFirestoreReady()) return;
        if(unsubscribeIngredientes){ return; }
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, onSnapshot, query, where } = window.fs;
        const q = query(collection(window.db, 'ingredientes'), where('userId','==', uid));
        unsubscribeIngredientes = onSnapshot(q, (snap)=>{
          if(snap.empty){ try{ maybeBootstrapIngredientesToFirestore(); }catch(_){} return; }
          const arr = []; snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
          appState.ingredientes = arr; saveLS(); renderAll();
        }, (err)=> console.warn('[FS] subscribeIngredientes', err));
      }catch(e){ console.warn('[FS] subscribeIngredientes(outside)', e); }
    }
    async function maybeBootstrapIngredientesToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, getDocs, doc, setDoc, query, where } = window.fs;
        const colRef = collection(window.db, 'ingredientes');
        const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.ingredientes) && appState.ingredientes.length>0){
          for(const i of appState.ingredientes){ await setDoc(doc(window.db, 'ingredientes', i.id), { ...i, userId: uid }, { merge:true }); }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapIngredientesToFirestore', e); }
    }

    // --- Firestore: Clientes ---
    async function saveClienteToFirestore(cli){
      try{
        if(!isFirestoreReady() || !cli?.id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'clientes', cli.id), { ...cli, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveClienteToFirestore', e); }
    }
    async function deleteClienteFromFirestore(id){
      try{
        if(!isFirestoreReady() || !id) return;
        const { doc, deleteDoc } = window.fs;
        await deleteDoc(doc(window.db, 'clientes', id));
      }catch(e){ console.warn('[FS] deleteClienteFromFirestore', e); }
    }
    function subscribeClientes(){
      try{
        if(!isFirestoreReady()) return;
        if(unsubscribeClientes){ return; }
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, onSnapshot, query, where } = window.fs;
        const q = query(collection(window.db, 'clientes'), where('userId','==', uid));
        unsubscribeClientes = onSnapshot(q, (snap)=>{
          if(snap.empty){ try{ maybeBootstrapClientesToFirestore(); }catch(_){} return; }
          const arr = []; snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
          appState.clientes = arr; saveLS(); renderAll();
        }, (err)=> console.warn('[FS] subscribeClientes', err));
      }catch(e){ console.warn('[FS] subscribeClientes(outside)', e); }
    }
    async function maybeBootstrapClientesToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, getDocs, doc, setDoc, query, where } = window.fs;
        const colRef = collection(window.db, 'clientes');
        const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.clientes) && appState.clientes.length>0){
          for(const c of appState.clientes){ await setDoc(doc(window.db, 'clientes', c.id), { ...c, userId: uid }, { merge:true }); }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapClientesToFirestore', e); }
    }

    // --- Firestore: Ventas ---
    async function saveVentaToFirestore(v){
      try{
        if(!isFirestoreReady() || !v?.id) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'ventas', v.id), { ...v, userId: uid }, { merge:true });
      }catch(e){ console.warn('[FS] saveVentaToFirestore', e); }
    }
    function subscribeVentas(){
      try{
        if(!isFirestoreReady()) return;
        if(unsubscribeVentas){ return; }
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, onSnapshot, query, where } = window.fs;
        const q = query(collection(window.db, 'ventas'), where('userId','==', uid));
        unsubscribeVentas = onSnapshot(q, (snap)=>{
          // Si está vacío, no forzamos reemplazo local; dejamos bootstrap manual si se desea
          const arr = []; snap.forEach(d=>{ const data=d.data(); if(data && data.id) arr.push(data); });
          if(arr.length===0) return;
          appState.ventas = arr;
          try{ assignSaleNumbersIfMissing(); }catch(_){ }
          try{ recomputeInsumosFromVentas(); }catch(_){ }
          saveLS(); renderAll();
        }, (err)=> console.warn('[FS] subscribeVentas', err));
      }catch(e){ console.warn('[FS] subscribeVentas(outside)', e); }
    }
    async function maybeBootstrapVentasToFirestore(){
      try{
        if(!isFirestoreReady()) return;
        const uid = window.auth?.currentUser?.uid; if(!uid) return;
        const { collection, getDocs, doc, setDoc, query, where } = window.fs;
        const colRef = collection(window.db, 'ventas');
        const snap = await getDocs(query(colRef, where('userId','==', uid)));
        if(snap.empty && Array.isArray(appState.ventas) && appState.ventas.length>0){
          for(const v of appState.ventas){ await setDoc(doc(window.db, 'ventas', v.id), { ...v, userId: uid }, { merge:true }); }
        }
      }catch(e){ console.warn('[FS] maybeBootstrapVentasToFirestore', e); }
    }

    function startFirestoreAllSync(){
      subscribeProducts();
      subscribeIngredientes();
      subscribeClientes();
      subscribeVentas();
      subscribeCompras();
      subscribeInsumos();
      subscribePedidos();
      subscribeMeta();
      // bootstraps
      maybeBootstrapProductsToFirestore();
      maybeBootstrapIngredientesToFirestore();
      maybeBootstrapClientesToFirestore();
      maybeBootstrapVentasToFirestore();
      maybeBootstrapComprasToFirestore();
      maybeBootstrapInsumosToFirestore();
      maybeBootstrapPedidosToFirestore();
      maybeBootstrapMetaToFirestore();
    }

    // --- Firestore: Inventario Compras ---
    async function saveCompraToFirestore(compra){
      try{ if(!isFirestoreReady()||!compra?.id) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'compras',compra.id),{...compra,userId:uid},{merge:true}); }catch(e){ console.warn('[FS] saveCompra',e); }
    }
    async function subscribeCompras(){
      try{ if(!isFirestoreReady()) return; if(unsubscribeCompras) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,onSnapshot,query,where}=window.fs; const q=query(collection(window.db,'compras'),where('userId','==',uid)); unsubscribeCompras=onSnapshot(q,(snap)=>{ const arr=[]; snap.forEach(d=>{const x=d.data(); if(x&&x.id) arr.push(x);}); appState.inventario=computedMergeInventario(appState.inventario,{compras:arr}); saveLS(); renderInventario(); },(err)=>console.warn('[FS] subscribeCompras',err)); }catch(e){ console.warn('[FS] subscribeCompras(outside)',e); }
    }
    async function maybeBootstrapComprasToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,getDocs,doc,setDoc,query,where}=window.fs; const colRef=collection(window.db,'compras'); const snap=await getDocs(query(colRef,where('userId','==',uid))); if(snap.empty && Array.isArray(appState.inventario?.compras) && appState.inventario.compras.length>0){ for(const c of appState.inventario.compras){ await setDoc(doc(window.db,'compras',c.id),{...c,userId:uid},{merge:true}); } } }catch(e){ console.warn('[FS] maybeBootstrapCompras',e); } }
    function computedMergeInventario(curr, next){ return { compras: Array.isArray(next?.compras)? next.compras : (curr?.compras||[]) }; }

    // --- Firestore: Insumos (doc único por usuario) ---
    async function saveInsumosToFirestore(){
      try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; const payload={ totales: appState.insumosConsumo?.totales||{}, historial: appState.insumosConsumo?.historial||[], merma: appState.insumosConsumo?.merma||[] }; await setDoc(doc(window.db,'insumos',uid),{ userId: uid, ...payload },{merge:true}); }catch(e){ console.warn('[FS] saveInsumos',e); }
    }
    function subscribeInsumos(){
      try{ if(!isFirestoreReady()) return; if(unsubscribeInsumos) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,onSnapshot}=window.fs; const ref=doc(window.db,'insumos',uid); unsubscribeInsumos=onSnapshot(ref,(snap)=>{ if(!snap.exists()) return; const data=snap.data(); if(!data) return; appState.insumosConsumo = { totales: data.totales||{}, historial: data.historial||[], merma: data.merma||[] }; saveLS(); renderInsumosView(); renderInventario(); },(err)=>console.warn('[FS] subscribeInsumos',err)); }catch(e){ console.warn('[FS] subscribeInsumos(outside)',e); }
    }
  async function maybeBootstrapInsumosToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,getDoc,setDoc}=window.fs; const ref=doc(window.db,'insumos',uid); const s=await getDoc(ref); if(!s.exists() && appState.insumosConsumo){ await setDoc(ref,{ userId:uid, ...appState.insumosConsumo },{merge:true}); } }catch(e){ console.warn('[FS] maybeBootstrapInsumos',e); }
  }

    // --- Firestore: Pedidos pendientes ---
    async function savePedidoToFirestore(p){ try{ if(!isFirestoreReady()||!p?.id) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'pedidos',p.id),{...p,userId:uid},{merge:true}); }catch(e){ console.warn('[FS] savePedido',e); }
    }
    async function deletePedidoFromFirestore(id){ try{ if(!isFirestoreReady()||!id) return; const {doc,deleteDoc}=window.fs; await deleteDoc(doc(window.db,'pedidos',id)); }catch(e){ console.warn('[FS] deletePedido',e); } }
    function subscribePedidos(){ try{ if(!isFirestoreReady()) return; if(unsubscribePedidos) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,onSnapshot,query,where}=window.fs; const q=query(collection(window.db,'pedidos'),where('userId','==',uid)); unsubscribePedidos=onSnapshot(q,(snap)=>{ const arr=[]; snap.forEach(d=>{ const x=d.data(); if(x&&x.id) arr.push(x); }); appState.pedidosPendientes=arr; saveLS(); renderPedidosPendientes(); },(err)=>console.warn('[FS] subscribePedidos',err)); }catch(e){ console.warn('[FS] subscribePedidos(outside)',e); }
    }
  async function maybeBootstrapPedidosToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {collection,getDocs,doc,setDoc,query,where}=window.fs; const colRef=collection(window.db,'pedidos'); const snap=await getDocs(query(colRef,where('userId','==',uid))); if(snap.empty && Array.isArray(appState.pedidosPendientes) && appState.pedidosPendientes.length>0){ for(const p of appState.pedidosPendientes){ await setDoc(doc(window.db,'pedidos',p.id),{...p,userId:uid},{merge:true}); } } }catch(e){ console.warn('[FS] maybeBootstrapPedidos',e); }
  }

    // --- Firestore: Meta (nextSaleNumber) ---
    async function saveMetaToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,setDoc}=window.fs; await setDoc(doc(window.db,'meta',uid),{ userId:uid, nextSaleNumber: Number(appState.nextSaleNumber)||1 },{merge:true}); }catch(e){ console.warn('[FS] saveMeta',e); }
    }
    function subscribeMeta(){ try{ if(!isFirestoreReady()) return; if(unsubscribeMeta) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,onSnapshot}=window.fs; const ref=doc(window.db,'meta',uid); unsubscribeMeta=onSnapshot(ref,(snap)=>{ if(!snap.exists()) return; const data=snap.data(); if(typeof data?.nextSaleNumber==='number'){ appState.nextSaleNumber = Math.max(appState.nextSaleNumber||1, data.nextSaleNumber); } },(err)=>console.warn('[FS] subscribeMeta',err)); }catch(e){ console.warn('[FS] subscribeMeta(outside)',e); }
    }
  async function maybeBootstrapMetaToFirestore(){ try{ if(!isFirestoreReady()) return; const uid=window.auth?.currentUser?.uid; if(!uid) return; const {doc,getDoc,setDoc}=window.fs; const ref=doc(window.db,'meta',uid); const s=await getDoc(ref); if(!s.exists()){ await setDoc(ref,{ userId:uid, nextSaleNumber: Number(appState.nextSaleNumber)||1 },{merge:true}); } }catch(e){ console.warn('[FS] maybeBootstrapMeta',e); } }

    // Dataset de ingredientes predefinidos (semilla)
    const PRESET_INGREDIENTS = [
      { nombre:'BOTECITO', precioPaquete:100.00, unidadesPaquete:100, unidad:'unidad' },
      { nombre:'Mantequilla Gloria', precioPaquete:269.10, unidadesPaquete:1170, unidad:'g' },
      { nombre:'Galletas Marbu', precioPaquete:20.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Cocoa', precioPaquete:90.00, unidadesPaquete:250, unidad:'g' },
      { nombre:'QUESO NACHOS', precioPaquete:200.00, unidadesPaquete:4000, unidad:'g' },
      { nombre:'Cocacola 1.75', precioPaquete:39.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Queso Bola', precioPaquete:494.00, unidadesPaquete:1900, unidad:'g' },
      { nombre:'SALCHICHAS JUMBO', precioPaquete:147.00, unidadesPaquete:20, unidad:'unidad' },
      { nombre:'PAN HAMBURGUESA PEQUEÑO', precioPaquete:75.00, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'Vegetales Hotdog', precioPaquete:4.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Queso Fiorelo', precioPaquete:31.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Cocacola 600Ml', precioPaquete:18.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'CHAROLA PEQUEÑA', precioPaquete:50.00, unidadesPaquete:25, unidad:'unidad' },
      { nombre:'Pepinillos', precioPaquete:140.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'CHAROLA UNISEL', precioPaquete:170.00, unidadesPaquete:50, unidad:'unidad' },
      { nombre:'PAPAS GAJO', precioPaquete:160.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'Maicena', precioPaquete:30.00, unidadesPaquete:300, unidad:'g' },
      { nombre:'TOCINO', precioPaquete:75.00, unidadesPaquete:16, unidad:'unidad' },
      { nombre:'QUESO AMERICANO', precioPaquete:162.90, unidadesPaquete:90, unidad:'unidad' },
      { nombre:'PAPEL GRADO ALIMENTICIO', precioPaquete:300.00, unidadesPaquete:1000, unidad:'unidad' },
      { nombre:'PAPAS FRANCESAS', precioPaquete:160.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'Ranch', precioPaquete:75.00, unidadesPaquete:750, unidad:'mL' },
      { nombre:'AROS DE CEBOLLA', precioPaquete:272.00, unidadesPaquete:100, unidad:'unidad' },
      { nombre:'MAYONESA', precioPaquete:306.00, unidadesPaquete:3400, unidad:'g' },
      { nombre:'Royal', precioPaquete:30.00, unidadesPaquete:500, unidad:'g' },
      { nombre:'Crema Avellana', precioPaquete:220.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'Costillas', precioPaquete:150.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'CARNE HAMBURGUESA SIRLON', precioPaquete:90.00, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'Vegetales', precioPaquete:8.00, unidadesPaquete:1, unidad:'unidad' },
      { nombre:'Harina', precioPaquete:20.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'SALSA BBQ', precioPaquete:42.00, unidadesPaquete:600, unidad:'g' },
      { nombre:'Crema lala 4L', precioPaquete:274.40, unidadesPaquete:3920, unidad:'g' },
      { nombre:'PAN HOTDOG', precioPaquete:69.96, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'Chispas de Chocolate', precioPaquete:200.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'CHILES', precioPaquete:2.00, unidadesPaquete:2, unidad:'unidad' },
      { nombre:'QUESO MANCHEGO', precioPaquete:150.00, unidadesPaquete:1000, unidad:'g' },
      { nombre:'Catsup', precioPaquete:144.00, unidadesPaquete:200, unidad:'unidad' },
      { nombre:'CARNE DE HAMBURGUESA', precioPaquete:125.00, unidadesPaquete:10, unidad:'unidad' },
      { nombre:'Azucar Mascabada', precioPaquete:80.00, unidadesPaquete:2000, unidad:'g' },
      { nombre:'AGUAS', precioPaquete:86.00, unidadesPaquete:18, unidad:'unidad' },
      { nombre:'BIMBOLLO', precioPaquete:90.96, unidadesPaquete:12, unidad:'unidad' },
      { nombre:'SALCHICHA BAFAR JALAPEÑO', precioPaquete:38.00, unidadesPaquete:4, unidad:'PZ' },
      { nombre:'PAN HOTDOG MEDIA NOCHE', precioPaquete:42.00, unidadesPaquete:8, unidad:'PZ' }
    ];

    // Clientes predefinidos del usuario
    const PRESET_CLIENTES_USER = [
      { nombre:'JAIME', telefono:'9221579492', direccion:'Talcualoya', gastoTotal:200, puntos:20 },
      { nombre:'Viridiana Maciel', telefono:'9221569521', direccion:'Desconocida', gastoTotal:0, puntos:0 },
      { nombre:'pollero', telefono:'9221657362', direccion:'desconocido', gastoTotal:140, puntos:14 },
      { nombre:'Didi', telefono:'9222831642', direccion:'Desconocida', gastoTotal:160, puntos:16 },
      { nombre:'Miguel Pimentel', telefono:'5638430441', direccion:'Desconocido', gastoTotal:0, puntos:0 },
      { nombre:'paul', telefono:'9221745327', direccion:'centro', gastoTotal:200, puntos:20 },
      { nombre:'Pablo Verazas', telefono:'9221140524', direccion:'Desconocida', gastoTotal:780, puntos:78 },
      { nombre:'Jeronimo', telefono:'9221585606', direccion:'Desconocida', gastoTotal:510, puntos:51 },
      { nombre:'Hermano mimi', telefono:'desconocido', direccion:'desconocido', gastoTotal:340, puntos:34 },
      { nombre:'Fany', telefono:'9221306105', direccion:'Desconocida', gastoTotal:440, puntos:98 },
      { nombre:'CENDI', telefono:'desconocido', direccion:'desconocido', gastoTotal:0, puntos:0 },
      { nombre:'TONY DIVA', telefono:'9613612532', direccion:'nueva tacoteno', gastoTotal:340, puntos:34 },
      { nombre:'Karim', telefono:'9221928934', direccion:'Petrolera', gastoTotal:0, puntos:0 },
      { nombre:'Claudia', telefono:'9222053732', direccion:'Calle quintanarro colonia emiliano zapata', gastoTotal:0, puntos:0 },
      { nombre:'uriel', telefono:'9222108294', direccion:'coahuila 36', gastoTotal:440, puntos:224 },
      { nombre:'YOSHUA', telefono:'desconocido', direccion:'desconocido', gastoTotal:60, puntos:6 },
      { nombre:'ISRAEL UNI', telefono:'DESCONOCIDO', direccion:'DESCONOCIDO', gastoTotal:60, puntos:6 },
      { nombre:'Gladys Casa Rosa', telefono:'9222271093', direccion:'desconocida', gastoTotal:0, puntos:0 },
      { nombre:'Denise', telefono:'9222822876', direccion:'Calle tecnologico casa madera', gastoTotal:0, puntos:0 },
      { nombre:'Maribel Vecina', telefono:'9221281283', direccion:'Coahuila 31', gastoTotal:0, puntos:0 },
      { nombre:'denis vazques', telefono:'9222822876', direccion:'casa madera', gastoTotal:110, puntos:11 },
      { nombre:'SY', telefono:'9221135326', direccion:'CONGRESO', gastoTotal:120, puntos:12 },
      { nombre:'Mimi', telefono:'9221637737', direccion:'Coahuila 34', gastoTotal:320, puntos:320 },
      { nombre:'Tienda Esquina', telefono:'9221751654', direccion:'Tienda esquina Colonia 10 de mayo', gastoTotal:0, puntos:0 },
      { nombre:'Hernesto Martinez', telefono:'9221633150', direccion:'Desconocida', gastoTotal:200, puntos:20 },
      { nombre:'Yuri', telefono:'9221253602', direccion:'desconocido', gastoTotal:600, puntos:60 },
      { nombre:'Cristy Vinales', telefono:'228 288 9858', direccion:'Sor Juana Inés de la Cruz número 8 col obrera por el chilapeño casa de dos pisos color blanco con portones de aluminio color champagne.', gastoTotal:480, puntos:480 },
      { nombre:'Simon', telefono:'922 121 1457', direccion:'Bixiweb', gastoTotal:110, puntos:110 },
      { nombre:'Colonia Calle california', telefono:'9221286098', direccion:'Colonia calle california', gastoTotal:0, puntos:0 }
    ];

    function importUserClientsPreset(){
      try{
        if(!Array.isArray(PRESET_CLIENTES_USER) || PRESET_CLIENTES_USER.length===0){ alert('No hay clientes para importar.'); return; }
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const existing = new Set((appState.clientes||[]).map(c=> byName(c.nombre)));
        const toAdd = PRESET_CLIENTES_USER.filter(c=> !existing.has(byName(c.nombre)));
        if(toAdd.length===0){ alert('Todos los clientes ya existen.'); return; }
        appState.clientes.push(...toAdd.map(c=>({ id: generateId('cli'), nombre:c.nombre, telefono:c.telefono||'', direccion:c.direccion||'', puntos:Number(c.puntos)||0, gastoTotal:Number(c.gastoTotal)||0 })));
        saveLS(); renderAll();
        alert(`Importados ${toAdd.length} clientes.`);
      }catch(e){ console.warn('importUserClientsPreset', e); alert('Error importando clientes'); }
    }
    function importUserClientsPresetSilently(){
      try{
        if(!Array.isArray(PRESET_CLIENTES_USER) || PRESET_CLIENTES_USER.length===0) return;
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const existing = new Set((appState.clientes||[]).map(c=> byName(c.nombre)));
        const toAdd = PRESET_CLIENTES_USER.filter(c=> !existing.has(byName(c.nombre)));
        if(toAdd.length===0) return;
        appState.clientes.push(...toAdd.map(c=>({ id: generateId('cli'), nombre:c.nombre, telefono:c.telefono||'', direccion:c.direccion||'', puntos:Number(c.puntos)||0, gastoTotal:Number(c.gastoTotal)||0 })));
        saveLS();
      }catch(e){ console.warn('importUserClientsPresetSilently', e); }
    }

    // Modal de Producto con Receta
    function openProductModal(){
      console.log('[UI] Abrir modal Producto');
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      if(!backdrop||!container){ console.warn('[UI] modal elements missing'); }
      const ingOptions = appState.ingredientes.map(i=>`<option value="${i.id}">${i.nombre} (${i.unidad||''})</option>`).join('');
      const disabledRecipe = appState.ingredientes.length===0;

      const html = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
          <h3 class="text-lg font-bold mb-4" style="color:var(--burger-dark)">Nuevo Producto</h3>
          <form id="product-form" class="space-y-4">
            <div>
              <label class="block text-sm font-bold mb-1">Nombre</label>
              <input type="text" name="nombre" class="w-full input-modern p-2 rounded" placeholder="Ej. Hamburguesa Doble" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Precio (venta)</label>
              <input type="number" name="precio" class="w-full input-modern p-2 rounded" placeholder="0.00" min="0" step="0.01" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Descripción</label>
              <textarea name="descripcion" rows="3" class="w-full input-modern p-2 rounded" placeholder="Descripción para el menú"></textarea>
            </div>
            <div class="border-t pt-3">
              <div class="recipe-title-bar mb-2">
                <label class="block text-sm font-bold">Receta (ingredientes)</label>
                <button type="button" id="add-ingredient-row" class="btn-success btn-compact rounded" ${disabledRecipe?'disabled':''}>+ Agregar</button>
              </div>
              ${disabledRecipe? '<div class="p-3 text-sm rounded bg-yellow-100 text-yellow-800">Primero agrega ingredientes en la sección Ingredientes.</div>' : ''}
              <div id="recipe-rows" class="recipe-list space-y-2"></div>
              <div id="cost-estimate" class="text-xs opacity-70 mt-2"></div>
            </div>
            <div class="flex gap-2 pt-2">
              <button type="submit" class="btn-success px-4 py-2 rounded">Guardar</button>
              <button type="button" id="cancel-product-modal" class="btn-danger px-4 py-2 rounded">Cancelar</button>
            </div>
          </form>
        </div>`;

      container.innerHTML = html;
      backdrop.classList.remove('hidden');
      container.classList.remove('hidden');

      function addRow(defaultId='', defaultQty=''){
        const rows = $('#recipe-rows');
        if(!rows) return;
        const row = document.createElement('div');
        row.className = 'recipe-row';
        row.innerHTML = `
          <select class="select-compact input-modern rounded ing-select">
            <option value="">Seleccione ingrediente</option>
            ${ingOptions}
          </select>
          <input type="number" class="input-compact input-modern rounded qty-input" placeholder="Cant." min="0" step="any">
          <button type="button" class="btn-danger btn-compact rounded remove-row">×</button>
        `;
        rows.appendChild(row);
        if(defaultId){ row.querySelector('.ing-select').value = defaultId; }
        if(defaultQty!==''){ row.querySelector('.qty-input').value = defaultQty; }
        row.querySelector('.remove-row').addEventListener('click', ()=>{ row.remove(); recalcCost(); });
        row.querySelector('.ing-select').addEventListener('change', recalcCost);
        row.querySelector('.qty-input').addEventListener('input', recalcCost);
      }

      function recalcCost(){
        let cost = 0;
        const qtys = $$('#recipe-rows .qty-input');
        $$('#recipe-rows .ing-select').forEach((sel, idx)=>{
          const id = sel.value;
          const qty = parseFloat(qtys[idx]?.value||'0');
          if(!id || !qty) return;
          const ing = getIngredientById(id);
          cost += getUnitCost(ing) * qty;
        });
        const price = parseFloat(document.querySelector('#product-form [name="precio"]')?.value||'0')||0;
        const margin = price - cost;
        const pct = price>0 ? (margin/price*100) : 0;
        const el = $('#cost-estimate');
        if(el) el.textContent = `Costo: ${fmt(cost)} • Margen: ${fmt(margin)} (${pct.toFixed(1)}%)`;
      }

      $('#add-ingredient-row')?.addEventListener('click', ()=> addRow());
      if(!disabledRecipe) addRow();
      recalcCost();

    $('#cancel-product-modal')?.addEventListener('click', closeModal);
    document.querySelector('#product-form [name="precio"]')?.addEventListener('input', recalcCost);
      $('#product-form')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        console.log('[UI] Guardar Producto');
        try{
          const fd = new FormData(e.target);
          const data = Object.fromEntries(fd.entries());
          const receta = [];
          const sels = $$('#recipe-rows .ing-select');
          const qtys = $$('#recipe-rows .qty-input');
          for(let i=0;i<sels.length;i++){
            const ingredienteId = sels[i].value;
            const cantidad = parseFloat(qtys[i].value||'0');
            if(ingredienteId && cantidad>0){ receta.push({ ingredienteId, cantidad }); }
          }
    const costo = computeRecipeCost(receta);
    const prod = { id: generateId('p'), nombre:(data.nombre||'').trim()||'Sin nombre', precio:Number(data.precio)||0, descripcion:(data.descripcion||'').trim(), receta, costo };
      appState.productos.push(prod);
      if(typeof saveProductToFirestore === 'function') saveProductToFirestore(prod);
      saveLS(); renderAll(); renderPosProductList();
        }catch(err){ console.error('[UI] Error guardando producto', err); }
        closeModal();
      });
    }

    // Modal específico: crear ingrediente
    function openIngredientModal(){
      console.log('[UI] Abrir modal Ingrediente');
      openFormModal({
        title:'Nuevo Ingrediente',
        fields:[
          {name:'nombre', label:'Nombre', placeholder:'Queso, Tomate...', type:'text'},
          {name:'unidad', label:'Unidad', placeholder:'g, kg, L, unidad', type:'text'},
          {name:'precioPaquete', label:'Precio por Paquete', placeholder:'0.00', type:'number', min:0, step:'0.01'},
          {name:'unidadesPaquete', label:'Unidades por Paquete', placeholder:'1', type:'number', min:1, step:'1'}
        ],
        onSubmit:(data)=>{
          try{
            const ing = { id: generateId('ing'), nombre:(data.nombre||'').trim(), unidad:(data.unidad||'').trim(), precioPaquete:Number(data.precioPaquete)||0, unidadesPaquete:Number(data.unidadesPaquete)||1 };
            appState.ingredientes.push(ing);
            if(typeof saveIngredientToFirestore==='function') saveIngredientToFirestore(ing);
            saveLS(); renderAll();
          }catch(err){ console.error('[UI] Error guardando ingrediente', err); }
        }
      });
    }

    // Importar preset manualmente
    function importPresetIngredients(){
      if(!Array.isArray(PRESET_INGREDIENTS) || PRESET_INGREDIENTS.length===0){ alert('No hay listado predefinido.'); return; }
      if(!confirm('¿Importar listado de ingredientes predefinido?\nSi ya tienes algunos, se añadirán sin borrar.')) return;
      const existingNames = new Set(appState.ingredientes.map(i=>i.nombre.toLowerCase()));
      const toAdd = PRESET_INGREDIENTS.filter(i=> !existingNames.has((i.nombre||'').toLowerCase()));
      appState.ingredientes.push(...toAdd.map(i=>({ id: generateId('ing'), ...i })));
      saveLS(); renderAll(); renderIngredientesTabla();
      alert(`Importados ${toAdd.length} ingredientes nuevos.`);
    }

    // Importación silenciosa (sin confirm/alert), merge por nombre (case-insensitive)
    function importPresetIngredientsSilently(){
      if(!Array.isArray(PRESET_INGREDIENTS) || PRESET_INGREDIENTS.length===0) return;
      const existingNames = new Set((appState.ingredientes||[]).map(i=> (i.nombre||'').toLowerCase()));
      const toAdd = PRESET_INGREDIENTS.filter(i=> !existingNames.has((i.nombre||'').toLowerCase()));
      if(toAdd.length===0) return;
      appState.ingredientes.push(...toAdd.map(i=>({ id: generateId('ing'), ...i })));
      saveLS();
    }

    // --- Importar Producto desde texto pegado ---
    function normalizeUnidad(u){
      const s=(u||'').trim().toLowerCase();
      if(['pz','pza','pieza','piezas','unidad','unidades'].includes(s)) return 'unidad';
      if(['gr','gramo','gramos','g'].includes(s)) return 'g';
      if(['lt','litro','litros','l'].includes(s)) return 'L';
      return u||'unidad';
    }
    function ensureIngredientExists(nombre, unidad, unitPrice){
      const byName = (n)=> (n||'').toString().trim().toLowerCase();
      const existing = (appState.ingredientes||[]).find(i=> byName(i.nombre)===byName(nombre));
      if(existing) return existing;
      const ing = { id: generateId('ing'), nombre: (nombre||'').toString().trim(), unidad: normalizeUnidad(unidad), precioPaquete: Number(unitPrice)||0, unidadesPaquete: 1 };
      appState.ingredientes.push(ing);
      return ing;
    }
    function parseProductImportText(text){
      const receta = [];
      const lines = (text||'').split(/\r?\n/).map(l=>l.trim());
      for(let i=0;i<lines.length;i++){
        const line = lines[i];
        if(!line) continue;
        const m = line.match(/^(.+?)\s*-\s*\$\s*([\d.,]+)\s*\/\s*([A-Za-zÁÉÍÓÚáéíóúñÑ]+)\s*$/);
        if(!m) continue;
        const ingName = m[1].trim();
        const unitPrice = parseFloat(m[2].replaceAll(',',''));
        const unidad = normalizeUnidad(m[3]);
        // Buscar cantidad en las siguientes líneas
        let qty = 1;
        if(i+1<lines.length && /^(\d+[\d.,]*)$/.test(lines[i+1])){
          qty = parseFloat(lines[i+1].replaceAll(',',''));
          // si hay línea de unidad o símbolo ×, sáltala
          if(i+2<lines.length && (/^[A-Za-zÁÉÍÓÚáéíóúñÑ]+$/.test(lines[i+2]) || /^×/.test(lines[i+2]))){
            i += 2;
          } else {
            i += 1;
          }
        }
        // Asegurar ingrediente
        const ing = ensureIngredientExists(ingName, unidad, unitPrice);
        if(ing){ receta.push({ nombre: ingName, cantidad: qty }); }
      }
      return { receta };
    }
    function openImportProductoModal(){
      openFormModal({
        title:'Importar Producto desde Texto',
        fields:[
          {name:'nombre', label:'Nombre del producto', placeholder:'Ej. Hamburguesa Especial', type:'text'},
          {name:'precio', label:'Precio de venta', placeholder:'0.00', type:'number', min:0, step:'0.01'},
          {name:'descripcion', label:'Descripción (opcional)', type:'textarea', rows:2, placeholder:'Descripción para el menú'},
          {name:'contenido', label:'Pega aquí la receta (texto)', type:'textarea', rows:10, placeholder:'Pega el bloque con ingredientes...'}
        ],
        submitText:'Importar',
        onSubmit:(data)=>{
          try{
            const nombre = (data.nombre||'').trim();
            const precio = Number(data.precio)||0;
            const descripcion = (data.descripcion||'').trim();
            const parsed = parseProductImportText(data.contenido||'');
            if(!parsed.receta || parsed.receta.length===0){ alert('No se detectaron ingredientes. Revisa el formato.'); return; }
            addOrUpdateProductWithRecipe({ nombre: nombre||'Sin nombre', precio, descripcion, receta: parsed.receta });
            saveLS(); renderAll(); renderIngredientesTabla(); renderPosProductList();
            alert(`Producto importado con ${parsed.receta.length} ingredientes.`);
          }catch(err){ console.error('Importar Producto', err); alert('Error importando el producto.'); }
        }
      });
    }

    // Sidebar móvil (reintroducido)
    function setupSidebar(){
      const btn = $('#mobile-menu-btn');
      const sidebar = document.querySelector('.sidebar');
      const backdrop = document.getElementById('sidebar-backdrop');
      const toggle = (open)=>{
        if(!sidebar) return;
        if(open===undefined) open = !sidebar.classList.contains('open');
        sidebar.classList.toggle('open', open);
        if(backdrop){ backdrop.classList.toggle('hidden', !open); }
      };
      btn?.addEventListener('click', ()=> toggle());
      backdrop?.addEventListener('click', ()=> toggle(false));
      document.addEventListener('click', (e)=>{
        if(window.innerWidth<=1024 && sidebar?.classList.contains('open')){
          const inside = sidebar.contains(e.target) || btn.contains(e.target);
          if(!inside) toggle(false);
        }
      });
    }

    // Navegación
    function setupNavigation(){
      const sidebar = document.querySelector('.sidebar');
      // Listeners directos (por si el DOM es estático)
      $$('.nav-link').forEach(a=> a.addEventListener('click', (e)=>{
        e.preventDefault();
        const link = e.currentTarget;
        const id = (link.getAttribute('href')||'').replace('#','');
        if(id) showView(id);
        if(window.innerWidth <= 1024 && sidebar?.classList.contains('open')) sidebar.classList.remove('open');
      }));
      // Delegación global (respaldo si los directos no se adjuntan por timing)
      document.addEventListener('click', (e)=>{
        const link = e.target.closest('a.nav-link');
        if(!link) return;
        e.preventDefault();
        const id = (link.getAttribute('href')||'').replace('#','');
        if(id) showView(id);
        if(window.innerWidth <= 1024 && sidebar?.classList.contains('open')) sidebar.classList.remove('open');
      });
      // Navegar con el hash de la URL
      function navigateToHash(){
        const id = (location.hash||'').replace('#','') || 'dashboard';
        const exists = document.getElementById('view-'+id);
        showView(exists ? id : 'dashboard');
      }
      window.addEventListener('hashchange', navigateToHash);
      // Sincronizar al inicio
      navigateToHash();
    }
    function showView(id){
      try{
        console.log('[NAV] showView ->', id);
        const targetId = 'view-' + id; // fix: incluir guión
        const views = $$('.view');
        let found = false;
        views.forEach(v=>{
          if(v.id===targetId){ v.classList.add('active'); v.style.display='block'; found = true; }
          else { v.classList.remove('active'); v.style.display='none'; }
        });
        if(!found){ console.warn('[NAV] Vista no encontrada:', targetId); }
        $$('.nav-link').forEach(a=> a.classList.toggle('active', a.getAttribute('href')==='#'+id));
        if(id==='dashboard') updateDashboard();
        if(id==='vender'){
          try{ document.getElementById('pos-search-input').value=''; }catch(_){ }
          posCategoryFilter = 'all';
          document.querySelectorAll('.pos-cat-btn')?.forEach(b=> b.classList.remove('bg-white'));
          const allBtn = document.querySelector('.pos-cat-btn[data-pos-cat="all"]');
          if(allBtn) allBtn.classList.add('bg-white');
          renderPosProductList();
        }
  if(id==='reportes') renderCharts();
  if(id==='inventario') renderInventario();
        if(id==='pedidos-pendientes') renderPedidosPendientes();
        if(id==='productos') renderProductosTabla();
        if(id==='ingredientes') renderIngredientesTabla();
  if(id==='insumos') renderInsumosView();
        if(id==='clientes') renderClientesTabla();
        if(id==='ventas') renderVentasTabla();
      }catch(e){ console.error('[NAV] showView error', e); }
    }

    // Render
    function updateDashboard(){
      const period = document.getElementById('db-period-select')?.value || '7d';
      const now = new Date();
      const start = (()=>{
        const d = new Date(now);
        if(period==='today'){ d.setHours(0,0,0,0); return d; }
        if(period==='30d'){ d.setDate(d.getDate()-30); return d; }
        if(period==='month'){ const x = new Date(d.getFullYear(), d.getMonth(), 1); return x; }
        if(period==='all'){ return new Date(0); }
        d.setDate(d.getDate()-7); return d; // 7d
      })();
      const ventas = (appState.ventas||[])
        .filter(v=> !v?.cancelada)
        .filter(v=> new Date(v.fecha)>=start && new Date(v.fecha)<=now);
      const prevStart = (()=>{
        if(period==='today'){ const x = new Date(start); x.setDate(x.getDate()-1); return x; }
        if(period==='30d'){ const x = new Date(start); x.setDate(x.getDate()-30); return x; }
        if(period==='month'){ const lastMonth = new Date(start); lastMonth.setMonth(lastMonth.getMonth()-1); return lastMonth; }
        if(period==='all'){ return new Date(0); }
        const x = new Date(start); x.setDate(x.getDate()-7); return x;
      })();
      const prevVentas = (appState.ventas||[])
        .filter(v=> !v?.cancelada)
        .filter(v=> new Date(v.fecha)>=prevStart && new Date(v.fecha)<start);

      const sum = (arr, f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
      const total = sum(ventas, v=> v.total||0);
      const orders = ventas.length;
      const items = sum(ventas, v=> sum(v.items||[], it=> it.cantidad||0));
      const discount = sum(ventas, v=> v.descuento||0);
      const shipping = sum(ventas, v=> v.costoEnvio||0);
      const aov = orders>0 ? total/orders : 0;
      // Prev period for trend
      const prevTotal = sum(prevVentas, v=> v.total||0);
      const prevOrders = prevVentas.length;
      const prevItems = sum(prevVentas, v=> sum(v.items||[], it=> it.cantidad||0));
      const prevAov = prevOrders>0 ? (sum(prevVentas, v=> v.total||0)/prevOrders) : 0;
      const trendPct = (curr, prev)=>{
        if(prev<=0) return 100; // base
        return Math.round(((curr - prev)/prev)*100);
      };

      // KPIs
      const setText = (id, txt)=>{ const el = document.getElementById(id); if(el) el.textContent = txt; };
      const setTrend = (id, curr, prev)=>{
        const el = document.getElementById(id);
        if(!el) return;
        const pct = trendPct(curr, prev);
        el.className = 'kpi-trend ' + (pct>=0? 'kpi-up':'kpi-down');
        el.textContent = (pct>=0? '▲ ':'▼ ') + Math.abs(pct) + '%';
      };
      setText('kpi-revenue', fmt(total)); setTrend('kpi-revenue-trend', total, prevTotal);
      setText('kpi-orders', String(orders)); setTrend('kpi-orders-trend', orders, prevOrders);
      setText('kpi-aov', fmt(aov)); setTrend('kpi-aov-trend', aov, prevAov);
      setText('kpi-items', String(items)); setTrend('kpi-items-trend', items, prevItems);
      setText('kpi-discount', fmt(discount));
      setText('kpi-shipping', fmt(shipping));
      // Top product
      const productCounts = {};
      ventas.forEach(v=> (v.items||[]).forEach(it=>{ productCounts[it.nombre] = (productCounts[it.nombre]||0) + (it.cantidad||0); }));
      const topProd = Object.keys(productCounts).sort((a,b)=> productCounts[b]-productCounts[a])[0];
      setText('kpi-top-product', topProd || '—');
      // Top client
      const clientTotals = {};
      ventas.forEach(v=>{ if(v.clienteId){ clientTotals[v.clienteId] = (clientTotals[v.clienteId]||0) + (v.total||0); } });
      const topClientId = Object.keys(clientTotals).sort((a,b)=> clientTotals[b]-clientTotals[a])[0];
      const topClientName = topClientId ? (appState.clientes.find(c=>c.id===topClientId)?.nombre || '—') : '—';
      setText('kpi-top-client', topClientName);

      // Ventas recientes
      const tbody = document.getElementById('db-ventas-recientes-body');
      if(tbody){
        tbody.innerHTML='';
        const rec = ventas.slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).slice(0,10);
        if(rec.length===0){ tbody.innerHTML='<tr><td colspan="4" class="p-3 text-center opacity-60">Sin ventas</td></tr>'; }
        else {
          rec.forEach(v=>{ const c = appState.clientes.find(x=>x.id===v.clienteId); const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : `#${String(v.id).slice(0,6)}`; const tr = document.createElement('tr'); tr.innerHTML = `<td class=\"p-2\">${label}</td><td class=\"p-2\">${c?c.nombre:'General'}</td><td class=\"p-2\">${new Date(v.fecha).toLocaleString()}</td><td class=\"p-2 text-right font-bold\">${fmt(v.total)}</td>`; tbody.appendChild(tr); });
        }
      }

      // Ventas por hora (hoy)
      const hourlyCanvas = document.getElementById('sales-hourly-chart');
      const emptyMsg = document.getElementById('sales-hourly-empty');
      if(hourlyCanvas){
        const d = new Date(); d.setHours(0,0,0,0);
        const todaySales = (appState.ventas||[])
          .filter(v=> !v?.cancelada)
          .filter(v=> new Date(v.fecha)>=d);
        const byHour = new Array(24).fill(0);
        todaySales.forEach(v=>{ const h = new Date(v.fecha).getHours(); byHour[h] += (v.total||0); });
        const hasData = todaySales.length>0 && byHour.some(x=> x>0);
        if(!hasData){ emptyMsg?.classList.remove('hidden'); }
        else { emptyMsg?.classList.add('hidden'); }
        const ctx = hourlyCanvas.getContext('2d');
        if(window.__hourlyChart){ window.__hourlyChart.destroy(); window.__hourlyChart = undefined; }
        const hourLabels = Array.from({ length: 24 }, (_, i) => (i<10?('0'+i):String(i)) + ':00');
        window.__hourlyChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: hourLabels,
            datasets: [ { label: 'Ingresos', data: byHour, backgroundColor: '#FF6B35' } ]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { ticks: { callback: (v)=> '$'+v } } }
          }
        });
      }
    }
    function renderProductosTabla(){
      const tb=$('#productos-list-body');
      if(!tb) return;
      tb.innerHTML='';
  // Usa lista visible deduplicada si existe el helper; fallback a filtro simple
  const visibles = (typeof getVisibleProducts==='function') ? getVisibleProducts() : (appState.productos||[]).filter(p=> !p.archivado);
  if(visibles.length===0){
        tb.innerHTML='<tr><td colspan="6" class="p-3 text-center opacity-60">Sin productos</td></tr>';
        return;
      }
  visibles.forEach(p=>{
        const tr=document.createElement('tr');
        const costo = (typeof p.costo==='number') ? p.costo : computeRecipeCost(p.receta||[]);
        const margen = (Number(p.precio)||0) - costo;
        const pct = (Number(p.precio)||0)>0 ? (margen/Number(p.precio)*100) : 0;
        tr.innerHTML=`
          <td class="p-2">${p.nombre}</td>
          <td class="p-2">${fmt(p.precio)}</td>
          <td class="p-2">${fmt(costo)}</td>
          <td class="p-2">${fmt(margen)} <span class="opacity-60 text-xs">(${pct.toFixed(1)}%)</span></td>
          <td class="p-2 text-sm opacity-80">${p.descripcion||''}</td>
          <td class="p-2 whitespace-nowrap">
            <button class="btn-gradient px-3 py-1 rounded text-sm mr-2 btn-edit-prod" data-id="${p.id}">Editar</button>
              <button class="px-3 py-1 rounded text-sm border mr-2 btn-derive-slice" title="Derivar subproducto (1/8)" data-id="${p.id}">Derivar 1/8</button>
            <button class="px-3 py-1 rounded text-sm border mr-2 btn-dup-prod" data-id="${p.id}">Duplicar</button>
            <button class="btn-danger px-3 py-1 rounded text-sm btn-del-prod" data-id="${p.id}">Eliminar</button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    function renderIngredientesTabla(){
      const tb=$('#ingredientes-list-body'); if(!tb) return;
      tb.innerHTML='';
      if(!Array.isArray(appState.ingredientes) || appState.ingredientes.length===0){
        tb.innerHTML='<tr><td colspan="5" class="p-3 text-center opacity-60">Sin ingredientes</td></tr>';
        return;
      }
      appState.ingredientes.forEach(i=>{
        const unitCost = getUnitCost(i);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2">${i.nombre}</td>
                      <td class="p-2">${i.unidad||''}</td>
                      <td class="p-2">${fmt(i.precioPaquete||0)}</td>
                      <td class="p-2">${i.unidadesPaquete||0}</td>
                      <td class="p-2">
                        <button class="btn-gradient px-3 py-1 rounded text-sm mr-2 btn-edit-ing" data-id="${i.id}">Editar</button>
                        <button class="btn-danger px-3 py-1 rounded text-sm btn-del-ing" data-id="${i.id}">Eliminar</button>
                      </td>`;
        tb.appendChild(tr);
      });
    }

    // Acciones de edición/eliminación en Ingredientes
    function setupIngredientesActions(){
      const tb = $('#ingredientes-list-body');
      if(!tb) return;
      tb.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const ing = appState.ingredientes.find(x=>x.id===id);
        if(btn.classList.contains('btn-edit-ing')){
          if(!ing) return;
          openFormModal({
            title:'Editar Ingrediente',
            fields:[
              {name:'nombre', label:'Nombre', type:'text', value:ing.nombre},
              {name:'unidad', label:'Unidad', type:'text', value:ing.unidad},
              {name:'precioPaquete', label:'Precio por Paquete', type:'number', min:0, step:'0.01', value:ing.precioPaquete},
              {name:'unidadesPaquete', label:'Unidades por Paquete', type:'number', min:1, step:'1', value:ing.unidadesPaquete}
            ],
            submitText:'Actualizar',
            onSubmit:(data)=>{
              ing.nombre=(data.nombre||'').trim();
              ing.unidad=(data.unidad||'').trim();
              ing.precioPaquete=Number(data.precioPaquete)||0;
              ing.unidadesPaquete=Number(data.unidadesPaquete)||1;
              if(typeof saveIngredientToFirestore==='function') saveIngredientToFirestore(ing);
              saveLS(); renderAll();
            }
          });
        } else if(btn.classList.contains('btn-del-ing')){
          if(!ing) return;
          if(confirm(`¿Eliminar ingrediente "${ing.nombre}"?`)){
            appState.ingredientes = appState.ingredientes.filter(x=>x.id!==id);
            if(typeof deleteIngredientFromFirestore==='function') deleteIngredientFromFirestore(id);
            saveLS(); renderAll();
          }
        }
      });
    }

    // Botones de crear (productos, ingredientes, clientes) e importar
    function setupCreateButtons(){
      document.getElementById('open-ingredientes-modal')?.addEventListener('click', openIngredientModal);
      document.getElementById('open-productos-modal')?.addEventListener('click', openProductModal);
  document.getElementById('import-producto-btn')?.addEventListener('click', openImportProductoModal);
      document.getElementById('open-clientes-modal')?.addEventListener('click', openClienteModal);
      document.getElementById('import-ingredientes-preset')?.addEventListener('click', importPresetIngredients);
  document.getElementById('import-clientes-preset')?.addEventListener('click', importUserClientsPreset);
    }

    // Botones Insumos
    (function setupInsumosButtons(){
  document.getElementById('insumos-recompute')?.addEventListener('click', ()=>{ recomputeInsumosFromVentas(); saveLS(); renderInsumosView(); renderInventario(); alert('Insumos recomputados desde ventas'); });
  document.getElementById('insumos-clear')?.addEventListener('click', ()=>{ if(confirm('¿Limpiar historial de insumos gastados?')){ appState.insumosConsumo = { totales:{}, historial:[], merma:[] }; saveLS(); if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore(); renderInsumosView(); } });
    })();

    // Modal de Cliente
    function openClienteModal(){
      openFormModal({
        title:'Nuevo Cliente',
        fields:[
          {name:'nombre', label:'Nombre', type:'text', placeholder:'Nombre y apellido'},
          {name:'telefono', label:'Teléfono', type:'text', placeholder:'Opcional'},
          {name:'direccion', label:'Dirección', type:'text', placeholder:'Opcional'}
        ],
        onSubmit:(data)=>{
          const cli = { id: generateId('cli'), nombre:(data.nombre||'').trim()||'Sin Nombre', telefono:(data.telefono||'').trim(), direccion:(data.direccion||'').trim(), puntos:0, gastoTotal:0 };
          appState.clientes.push(cli);
          if(typeof saveClienteToFirestore==='function') saveClienteToFirestore(cli);
          saveLS(); renderAll();
        }
      });
    }

    // Render tablas faltantes
      function renderClientesTabla(){
        const tb = document.getElementById('clientes-list-body');
        if(!tb) return;
        tb.innerHTML = '';
        const term = (document.getElementById('clientes-search')?.value||'').toLowerCase().trim();
        const sort = document.getElementById('clientes-sort')?.value||'nombre';
        let list = Array.isArray(appState.clientes) ? [...appState.clientes] : [];
        if(term){ list = list.filter(c=> (c.nombre||'').toLowerCase().includes(term) || (c.telefono||'').toLowerCase().includes(term) || (c.direccion||'').toLowerCase().includes(term)); }
        if(sort==='nombre') list.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
        if(sort==='puntos') list.sort((a,b)=> (b.puntos||0)-(a.puntos||0));
        if(sort==='gasto') list.sort((a,b)=> (b.gastoTotal||0)-(a.gastoTotal||0));
        if(sort==='reciente') list = list.slice().reverse();
      if(list.length===0){ tb.innerHTML = '<tr><td colspan="6" class="p-3 text-center opacity-60">Sin clientes</td></tr>'; return; }
        list.forEach(c=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2">${c.nombre}</td>
            <td class="p-2">${c.telefono||''}</td>
            <td class="p-2">${c.direccion||''}</td>
        <td class="p-2">${fmt(c.gastoTotal||0)}</td>
        <td class="p-2">${c.puntos||0}</td>
            <td class="p-2">
              <div class="flex gap-2">
          <button class="px-2 py-1 rounded border text-sm btn-hist-cli" data-id="${c.id}">Historial</button>
                <button class="px-2 py-1 rounded border text-sm btn-edit-cli" data-id="${c.id}">Editar</button>
                <button class="px-2 py-1 rounded border text-sm btn-del-cli" data-id="${c.id}">Eliminar</button>
                <button class="icon-btn text-sm btn-view-cli" title="Ver" data-id="${c.id}">👁️</button>
              </div>
            </td>`;
          tb.appendChild(tr);
        });
      }

      function renderClientesCards(){
        const grid = document.getElementById('clientes-grid');
        if(!grid) return;
        grid.innerHTML='';
        const term = (document.getElementById('clientes-search')?.value||'').toLowerCase().trim();
        const sort = document.getElementById('clientes-sort')?.value||'nombre';
        let list = Array.isArray(appState.clientes) ? [...appState.clientes] : [];
        if(term){ list = list.filter(c=> (c.nombre||'').toLowerCase().includes(term) || (c.telefono||'').toLowerCase().includes(term) || (c.direccion||'').toLowerCase().includes(term)); }
        if(sort==='nombre') list.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
        if(sort==='puntos') list.sort((a,b)=> (b.puntos||0)-(a.puntos||0));
        if(sort==='gasto') list.sort((a,b)=> (b.gastoTotal||0)-(a.gastoTotal||0));
        if(sort==='reciente') list = list.slice().reverse();
        if(list.length===0){ grid.innerHTML = '<div class="text-center py-8 opacity-60">Sin clientes</div>'; return; }
        list.forEach(c=>{
          const card = document.createElement('div');
          card.className = 'client-card';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="font-bold text-lg" style="color:var(--burger-dark)">${c.nombre}</div>
                <div class="text-sm opacity-70">${c.telefono||'—'}</div>
                <div class="text-sm opacity-70">${c.direccion||'—'}</div>
              </div>
              <div class="space-x-1 whitespace-nowrap">
                <button class="icon-btn btn-view-cli" title="Ver" data-id="${c.id}">👁️</button>
                <button class="icon-btn btn-edit-cli" title="Editar" data-id="${c.id}">✏️</button>
                <button class="icon-btn btn-del-cli" title="Eliminar" data-id="${c.id}">🗑️</button>
              </div>
            </div>
            <div class="mt-3 flex items-center gap-2">
              <span class="pill pill-points">⭐ ${c.puntos||0} pts</span>
              <span class="pill pill-spend">💰 ${fmt(c.gastoTotal||0)}</span>
            </div>
          `;
          grid.appendChild(card);
        });
      }

      function showClientesView(mode){
        const grid = document.getElementById('clientes-grid');
        const table = document.getElementById('clientes-table-wrapper');
        if(!grid || !table){
          try{ localStorage.setItem('clientes-view-mode', mode); }catch(_){ }
          return;
        }
        if(mode==='table'){
          grid.classList.add('hidden');
          table.classList.remove('hidden');
          renderClientesTabla();
        } else {
          table.classList.add('hidden');
          grid.classList.remove('hidden');
          renderClientesCards();
        }
        localStorage.setItem('clientes-view-mode', mode);
      }

    // Acciones de edición/eliminación en Clientes
    (function setupClientesActions(){
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest && e.target.closest('button');
        if(!btn) return;
        if(btn.classList.contains('btn-edit-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          openFormModal({
            title:'Editar Cliente',
            fields:[
              {name:'nombre', label:'Nombre', type:'text', value:c.nombre},
              {name:'telefono', label:'Teléfono', type:'text', value:c.telefono||''},
              {name:'direccion', label:'Dirección', type:'text', value:c.direccion||''}
            ],
            submitText:'Actualizar',
            onSubmit:(data)=>{
              c.nombre = (data.nombre||'').trim()||c.nombre;
              c.telefono = (data.telefono||'').trim();
              c.direccion = (data.direccion||'').trim();
              if(typeof saveClienteToFirestore==='function') saveClienteToFirestore(c);
              saveLS(); renderAll();
            }
          });
        } else if(btn.classList.contains('btn-del-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          if(confirm(`¿Eliminar cliente "${c.nombre}"?`)){
            appState.clientes = appState.clientes.filter(x=>x.id!==id);
            if(typeof deleteClienteFromFirestore==='function') deleteClienteFromFirestore(id);
            saveLS(); renderAll();
          }
        } else if(btn.classList.contains('btn-hist-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          const ventasCli = (appState.ventas||[]).filter(v=> v.clienteId===id).sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
          const total = ventasCli.reduce((s,v)=> s+(v.total||0), 0);
          const body = ventasCli.length===0 ? 'Sin ventas de este cliente' : ventasCli.map(v=> `${new Date(v.fecha).toLocaleString()}  •  ${fmt(v.total)}`).join('\n');
          openFormModal({
            title: `Historial de ${c.nombre} • Total: ${fmt(total)}`,
            fields:[ { name:'hist', label:'', type:'textarea', rows:10, value: body } ],
            submitText:'Cerrar',
            onSubmit:()=>{}
          });
        } else if(btn.classList.contains('btn-view-cli')){
          const id = btn.getAttribute('data-id');
          const c = appState.clientes.find(x=>x.id===id); if(!c) return;
          openFormModal({
            title: `Cliente: ${c.nombre}`,
            fields: [
              { name:'telefono', label:'Teléfono', type:'text', value:c.telefono||'', placeholder:'', readonly:true },
              { name:'direccion', label:'Dirección', type:'text', value:c.direccion||'', placeholder:'', readonly:true },
            ],
            submitText:'Cerrar',
            onSubmit:()=>{}
          });
        }
      });
    })();

    // Wire toolbar Clientes
    (function setupClientesToolbar(){
      const search = document.getElementById('clientes-search');
      const sort = document.getElementById('clientes-sort');
      const btnCards = document.getElementById('clientes-view-cards');
      const btnTable = document.getElementById('clientes-view-table');
      const mode = localStorage.getItem('clientes-view-mode')||'cards';
      if(mode==='table') showClientesView('table'); else showClientesView('cards');
      search?.addEventListener('input', ()=>{ renderClientesCards(); renderClientesTabla(); });
      sort?.addEventListener('change', ()=>{ renderClientesCards(); renderClientesTabla(); });
      btnCards?.addEventListener('click', ()=> showClientesView('cards'));
      btnTable?.addEventListener('click', ()=> showClientesView('table'));
    })();

    function renderVentasTabla(){
      const tb = document.getElementById('ventas-list-body');
      if(!tb) return;
      tb.innerHTML='';
      if(!Array.isArray(appState.ventas) || appState.ventas.length===0){
        tb.innerHTML = '<tr><td colspan="6" class="p-3 text-center opacity-60">Sin ventas</td></tr>';
        return;
      }
      const rows = (appState.ventas||[])
        .filter(v=> !v?.cancelada)
        .slice()
        .sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
      rows.forEach(v=>{
        const cli = appState.clientes.find(c=>c.id===v.clienteId);
        const tr = document.createElement('tr');
        const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : `#${String(v.id).slice(0,6)}`;
        tr.innerHTML = `
          <td class="p-2">${label}</td>
          <td class="p-2">${new Date(v.fecha).toLocaleString()}</td>
          <td class="p-2">${cli?cli.nombre:'General'}</td>
          <td class="p-2">${v.items?.length||0}</td>
          <td class="p-2 text-right font-bold">${fmt(v.total)}</td>
          <td class="p-2 flex items-center gap-2">
            <button class="px-2 py-1 rounded border text-sm btn-view-sale" data-id="${v.id}">Ver</button>
            <button class="px-2 py-1 rounded border border-red-300 text-red-700 hover:bg-red-50 text-sm btn-delete-sale" title="Cancelar venta" aria-label="Cancelar venta" data-id="${v.id}">✕</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }
    // Ver detalle de venta
    (function setupVentasActions(){
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest && e.target.closest('button.btn-view-sale');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const v = (appState.ventas||[]).find(x=>x.id===id);
        if(!v) return;
        const label = (typeof v.saleNumber==='number' && v.saleNumber>0) ? `Venta${v.saleNumber}` : `#${String(v.id).slice(0,6)}`;
        const lines = [];
        (v.items||[]).forEach(it=>{
          const unit = (Number(it.precio)||0) + ((it.modifiers||[]).reduce((a,m)=> a + (Number(m.price)||0), 0));
          const mods = (it.modifiers&&it.modifiers.length) ? ' ['+it.modifiers.map(m=> m.name + (m.price?` (+${fmt(m.price)})`:'' )).join(', ')+']' : '';
          lines.push(`${it.cantidad} × ${it.nombre}${mods}  •  ${fmt(unit)} c/u  =  ${fmt(unit*it.cantidad)}`);
        });
        lines.push('');
        lines.push(`Subtotal: ${fmt(v.subtotal||0)}`);
        if(v.descuento){ lines.push(`Descuento: -${fmt(v.descuento)}`); }
        if(v.costoEnvio){ lines.push(`Envío: ${fmt(v.costoEnvio)}`); }
        lines.push(`Total: ${fmt(v.total||0)}`);
        openFormModal({ title: `${label} • ${new Date(v.fecha).toLocaleString()}`, fields:[{ name:'detalle', label:'', type:'textarea', rows: Math.min(14, Math.max(8, lines.length+2)), value: lines.join('\n') }], submitText:'Cerrar', onSubmit:()=>{} });
      });
    })();

    // Helper: cancelar (soft-delete) venta en Firestore si está disponible
    async function deleteVentaFromFirestore(id){
      try{
        if(!window.db || !window.fs) return;
        const uid = window.auth?.currentUser?.uid;
        if(!uid) return;
        const { doc, setDoc } = window.fs;
        await setDoc(doc(window.db, 'ventas', id), { cancelada: true, cancelAt: new Date().toISOString(), userId: uid }, { merge: true });
      }catch(e){ console.warn('cancelVentaInFirestore', e); }
    }

    // Cancelar venta con confirmación (X)
    (function setupVentasDelete(){
      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest && e.target.closest('button.btn-delete-sale');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const venta = (appState.ventas||[]).find(v=> v.id===id);
        if(!venta) return;
        const label = (typeof venta.saleNumber==='number' && venta.saleNumber>0) ? `Venta${venta.saleNumber}` : `#${String(venta.id).slice(0,6)}`;
        if(venta.cancelada){ alert('Esta venta ya está cancelada.'); return; }
        if(!confirm(`¿Cancelar ${label}? No contará en reportes ni insumos.`)) return;
        // Local: marcar como cancelada
        venta.cancelada = true;
        venta.cancelAt = new Date().toISOString();
        // Si hubiera pedidos relacionados, removerlos
        try{
          const rels = (appState.pedidosPendientes||[]).filter(p=> p.ventaId===venta.id);
          if(rels.length){
            appState.pedidosPendientes = (appState.pedidosPendientes||[]).filter(p=> p.ventaId!==venta.id);
            if(typeof deletePedidoFromFirestore==='function'){
              rels.forEach(p=>{ try{ deletePedidoFromFirestore(p.id); }catch(_){} });
            }
          }
        }catch(_){}
        try{ recomputeInsumosFromVentas(); }catch(_){ }
        saveLS();
        renderVentasTabla();
        updateDashboard?.();
        renderInsumosView?.();
        // Cloud: persistir cancelación
        deleteVentaFromFirestore(id);
      });
    })();

    // ===================== INSUMOS GASTADOS =====================
    // Estructura: appState.insumosConsumo = { totales: { [ingId]: cantidad }, historial: [ { ventaId, fecha, items:[{ ingredienteId, nombre, unidad, cantidad }] } ] }
    function accumulateInsumosFromVenta(venta){
      try{
        if(!venta || !Array.isArray(venta.items)) return;
        const histItems = [];
        for(const it of (venta.items||[])){
          const prod = appState.productos.find(p=>p.id===it.productoId);
          const qty = Number(it.cantidad)||0; if(!prod || qty<=0) continue;
          const receta = Array.isArray(prod.receta)? prod.receta : [];
          for(const r of receta){
            const ing = appState.ingredientes.find(i=>i.id===r.ingredienteId);
            if(!ing) continue;
            const used = (Number(r.cantidad)||0) * qty;
            if(used<=0) continue;
            appState.insumosConsumo.totales[ing.id] = (appState.insumosConsumo.totales[ing.id]||0) + used;
            histItems.push({ ingredienteId: ing.id, nombre: ing.nombre, unidad: ing.unidad||'', cantidad: used });
          }
        }
        if(histItems.length>0){
          appState.insumosConsumo.historial.push({ ventaId: venta.id, fecha: venta.fecha, items: histItems });
        }
      }catch(e){ console.warn('accumulateInsumosFromVenta', e); }
    }

    function recomputeInsumosFromVentas(){
      appState.insumosConsumo = { totales:{}, historial:[] };
      for(const v of (appState.ventas||[])){
        if(v && !v.cancelada) accumulateInsumosFromVenta(v);
      }
  if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore();
    }

    function renderInsumosView(){
      const tb = document.getElementById('insumos-totales-body');
      const vb = document.getElementById('insumos-ventas-body');
      const mb = document.getElementById('insumos-mermas-body');
      if(!tb||!vb||!mb) return;
      tb.innerHTML=''; vb.innerHTML=''; mb.innerHTML='';
  // Stats (sin errores)
  const totEntries = Object.entries(appState.insumosConsumo.totales||{});
  const histArr = appState.insumosConsumo.historial||[];
  const mermArr = appState.insumosConsumo.merma||[];
  const sIngs = document.getElementById('ins-stat-ings'); if(sIngs) sIngs.textContent = String(totEntries.length);
  const sLines = document.getElementById('ins-stat-lines'); if(sLines) sLines.textContent = String(histArr.length + mermArr.length);
  const sMerm = document.getElementById('ins-stat-mermas'); if(sMerm) sMerm.textContent = String(mermArr.length);
  const sVend = document.getElementById('ins-stat-ventas'); if(sVend) sVend.textContent = String(histArr.length);
      // Totales
  const entries = totEntries;
      if(entries.length===0){ tb.innerHTML = '<tr><td colspan="4" class="p-3 text-center opacity-60">Sin consumo registrado</td></tr>'; }
      else{
        const rows = entries.map(([ingId,cant])=>{
          const ing = appState.ingredientes.find(i=>i.id===ingId);
          const unidad = ing?.unidad || '';
          const nombre = ing?.nombre || ingId;
          return `<tr>
            <td class="p-2">${nombre}</td>
            <td class="p-2">${unidad}</td>
            <td class="p-2 text-right">${(Number(cant)||0).toLocaleString()}</td>
            <td class="p-2"><button class="btn-danger px-2 py-1 rounded text-sm btn-add-merma" data-id="${ingId}">Merma</button></td>
          </tr>`;
        }).join('');
        tb.innerHTML = rows;
      }
      // Delegación para Merma (re-attach cada render)
      tb.querySelectorAll('.btn-add-merma').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const ingId = btn.getAttribute('data-id');
          const ing = appState.ingredientes.find(i=>i.id===ingId);
          openFormModal({
            title:`Registrar Merma: ${ing?.nombre||ingId}`,
            fields:[ { name:'cantidad', label:'Cantidad', type:'number', min:0, step:'0.01', value:'' } ],
            submitText:'Agregar',
            onSubmit:(data)=>{
              const qty = Number(data.cantidad)||0;
              if(qty<=0){ alert('Ingresa una cantidad mayor a 0'); return false; }
              if(!appState.insumosConsumo) appState.insumosConsumo = { totales:{}, historial:[], merma:[] };
              if(!appState.insumosConsumo.totales) appState.insumosConsumo.totales = {};
              if(!Array.isArray(appState.insumosConsumo.merma)) appState.insumosConsumo.merma = [];
              appState.insumosConsumo.totales[ingId] = (appState.insumosConsumo.totales[ingId]||0) + qty;
              appState.insumosConsumo.merma.push({ id: generateId('merma'), ingredienteId: ingId, cantidad: qty, fecha: new Date().toISOString() });
              saveLS(); renderInsumosView(); renderInventario();
                  if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore();
            }
          });
        });
      });
      // Ventas (consumo detallado)
    const hist = (appState.insumosConsumo.historial||[]).slice().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      if(hist.length===0){ vb.innerHTML = '<tr><td colspan="3" class="p-3 text-center opacity-60">Sin ventas registradas</td></tr>'; }
      else{
        hist.forEach(h=>{
          const tr = document.createElement('tr');
          const itemsTxt = (h.items||[]).map(i=> `${i.nombre}: ${i.cantidad}${i.unidad||''}`).join(', ');
      const venta = (appState.ventas||[]).find(v=> v.id===h.ventaId);
      const label = venta && venta.saleNumber ? `Venta${venta.saleNumber}` : `#${String(h.ventaId).slice(0,6)}`;
      tr.innerHTML = `<td class="p-2">${new Date(h.fecha).toLocaleString()}</td><td class="p-2"><span class="insumo-badge insumo-badge-venta">${label}</span></td><td class="p-2">${itemsTxt}</td>`;
          vb.appendChild(tr);
        });
      }
      // Mermas
      const mlist = (mermArr||[]).slice().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      if(mlist.length===0){ mb.innerHTML = '<tr><td colspan="3" class="p-3 text-center opacity-60">Sin mermas</td></tr>'; }
      else{
        mlist.forEach(m=>{
          const tr = document.createElement('tr');
          const ing = appState.ingredientes.find(i=>i.id===m.ingredienteId);
          const nombre = ing?.nombre || m.ingredienteId; const unidad = ing?.unidad || '';
          tr.innerHTML = `<td class="p-2">${new Date(m.fecha).toLocaleString()}</td><td class="p-2">${nombre}</td><td class="p-2">${m.cantidad}${unidad}</td>`;
          mb.appendChild(tr);
        });
      }
    }

    // POS: render de productos y manejo de orden
    function renderPosProductList(){
      const grid = document.getElementById('pos-product-list');
      if(!grid) return;
  const q = (document.getElementById('pos-search-input')?.value||'').trim().toLowerCase();
  grid.innerHTML='';
  const source = (typeof getVisibleProducts==='function')
    ? getVisibleProducts()
    : (Array.isArray(appState.productos) ? appState.productos.filter(p=> !p.archivado) : []);
  const inCat = (p)=> posCategoryFilter==='all' || (p.categoria||'').toLowerCase()===posCategoryFilter.toLowerCase();
  const list = source.filter(p=> inCat(p) && (!q || (p.nombre||'').toLowerCase().includes(q)));
  if(list.length===0){
        grid.innerHTML = '<div class="col-span-full text-center py-8 opacity-60">No hay productos. Crea algunos en la sección Productos.</div>';
        return;
      }
  list.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'product-card p-4 flex flex-col';
        card.innerHTML = `
          <div class="prod-name font-bold">${p.nombre}</div>
          <div class="prod-desc text-sm opacity-70 mb-3">${p.descripcion||''}</div>
          <div class="mt-auto flex items-center justify-between">
            <div class="text-lg font-extrabold">${fmt(p.precio)}</div>
      <button class="btn-success px-3 py-2 rounded text-sm btn-add-to-order" data-product-id="${p.id}">Agregar</button>
          </div>
        `;
  // Handler: abrir personalización antes de agregar
  card.querySelector('.btn-add-to-order')?.addEventListener('click', ()=> openCustomizeProductModal(p.id));
        grid.appendChild(card);
      });
      // Nota: listeners de cada tarjeta se eliminan automáticamente al limpiar el grid en próximas renderizaciones
    }

    // Delegación de acciones de productos
    function setupProductosActions(){
      const tb = document.getElementById('productos-list-body');
      if(!tb) return;
      tb.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        if(btn.classList.contains('btn-del-prod')){
          const prod = appState.productos.find(p=>p.id===id);
          if(prod){ prod.archivado = true; prod.archivedAt = new Date().toISOString(); }
          currentOrder.items = currentOrder.items.filter(i=>i.productoId!==id);
          if(typeof deleteProductFromFirestore === 'function') deleteProductFromFirestore(id);
          saveLS(); renderAll(); renderPosProductList(); updateOrderUI();
        } else if(btn.classList.contains('btn-dup-prod')){
          const p = appState.productos.find(x=>x.id===id); if(!p) return;
          const copy = JSON.parse(JSON.stringify(p));
          copy.id = generateId('p');
          copy.nombre = (p.nombre||'Producto') + ' (Copia)';
          appState.productos.push(copy);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(copy);
          saveLS(); renderAll(); renderPosProductList();
        } else if(btn.classList.contains('btn-edit-prod')){
          openProductEditModal(id);
        } else if(btn.classList.contains('btn-derive-slice')){
          // Derivar subproducto con divisor configurable (default 8)
          const parent = appState.productos.find(x=>x.id===id);
          if(!parent){ alert('Producto no encontrado'); return; }
          const name = prompt('Nombre del subproducto:', `Rebanada de ${parent.nombre}`);
          if(name===null) return;
          const divStr = prompt('Dividir cantidades y precio entre (ej. 8, 10, 12):', '8');
          const div = Math.max(1, Number(divStr)||8);
          deriveSubProductFrom(id, { childName: name, divisor: div, priceStrategy: 'divide' });
        }
      });
    }

    // Modal de edición de producto (con receta)
    function openProductEditModal(productId){
      const prod = appState.productos.find(p=>p.id===productId);
      if(!prod) return;
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      const ingOptions = appState.ingredientes.map(i=>`<option value="${i.id}">${i.nombre} (${i.unidad||''})</option>`).join('');
      const html = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
          <h3 class="text-lg font-bold mb-4" style="color:var(--burger-dark)">Editar Producto</h3>
          <form id="product-edit-form" class="space-y-4">
            <div>
              <label class="block text-sm font-bold mb-1">Nombre</label>
              <input type="text" name="nombre" class="w-full input-modern p-2 rounded" value="${prod.nombre||''}" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Precio (venta)</label>
              <input type="number" name="precio" class="w-full input-modern p-2 rounded" value="${Number(prod.precio)||0}" min="0" step="0.01" required>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Descripción</label>
              <textarea name="descripcion" rows="3" class="w-full input-modern p-2 rounded">${prod.descripcion||''}</textarea>
            </div>
            <div class="border-t pt-3">
              <div class="recipe-title-bar mb-2">
                <label class="block text-sm font-bold">Receta (ingredientes)</label>
                <button type="button" id="edit-add-ingredient-row" class="btn-success btn-compact rounded">+ Agregar</button>
              </div>
              <div id="edit-recipe-rows" class="recipe-list space-y-2"></div>
              <div id="edit-cost-estimate" class="text-xs opacity-70 mt-2"></div>
            </div>
            <div class="flex gap-2 pt-2">
              <button type="submit" class="btn-success px-4 py-2 rounded">Actualizar</button>
              <button type="button" id="cancel-product-edit" class="btn-danger px-4 py-2 rounded">Cancelar</button>
            </div>
          </form>
        </div>`;
      container.innerHTML = html;
      backdrop.classList.remove('hidden');
      container.classList.remove('hidden');

      function addRow(defaultIngId='', defaultQty=''){
        const rows = document.getElementById('edit-recipe-rows');
        const row = document.createElement('div');
        row.className = 'recipe-row';
        row.innerHTML = `
          <select class=\"select-compact input-modern rounded ing-select\">${ingOptions}</select>
          <input type=\"number\" class=\"input-compact input-modern rounded qty-input\" placeholder=\"Cant.\" min=\"0\" step=\"any\">
          <button type=\"button\" class=\"btn-danger btn-compact rounded remove-row\">×</button>
        `;
        rows.appendChild(row);
        if(defaultIngId){ row.querySelector('.ing-select').value = defaultIngId; }
        if(defaultQty!==undefined && defaultQty!==''){ row.querySelector('.qty-input').value = String(defaultQty); }
        row.querySelector('.remove-row').addEventListener('click', ()=> { row.remove(); recalcEditCost(); });
        row.querySelector('.ing-select').addEventListener('change', recalcEditCost);
        row.querySelector('.qty-input').addEventListener('input', recalcEditCost);
      }
      // Prefill receta
      (prod.receta||[]).forEach(r=> addRow(r.ingredienteId, r.cantidad));
      if(!prod.receta || prod.receta.length===0) addRow();
      document.getElementById('edit-add-ingredient-row')?.addEventListener('click', ()=> addRow());
      document.getElementById('cancel-product-edit')?.addEventListener('click', closeModal);
      function recalcEditCost(){
        let cost = 0;
        const rows = Array.from(document.querySelectorAll('#edit-recipe-rows .recipe-row'));
        rows.forEach(r=>{
          const sel = r.querySelector('.ing-select');
          const qty = parseFloat(r.querySelector('.qty-input')?.value||'0');
          const ing = getIngredientById(sel?.value);
          if(ing && qty>0) cost += getUnitCost(ing) * qty;
        });
        const price = parseFloat(document.querySelector('#product-edit-form [name=\"precio\"]')?.value||'0')||0;
        const margin = price - cost;
        const pct = price>0 ? (margin/price*100) : 0;
        const el = document.getElementById('edit-cost-estimate');
        if(el) el.textContent = `Costo: ${fmt(cost)} • Margen: ${fmt(margin)} (${pct.toFixed(1)}%)`;
      }
      recalcEditCost();
      document.querySelector('#product-edit-form [name="precio"]')?.addEventListener('input', recalcEditCost);
      document.getElementById('product-edit-form')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        prod.nombre = (fd.get('nombre')||'').toString().trim()||prod.nombre;
        prod.precio = parseFloat(fd.get('precio'))||0;
        prod.descripcion = (fd.get('descripcion')||'').toString();
        const sels = Array.from(document.querySelectorAll('#edit-recipe-rows .ing-select'));
        const qtys = Array.from(document.querySelectorAll('#edit-recipe-rows .qty-input'));
        const nuevaReceta = [];
        for(let i=0;i<sels.length;i++){
          const ingredienteId = sels[i].value;
          const cantidad = parseFloat(qtys[i].value||'0');
          if(ingredienteId && cantidad>0) nuevaReceta.push({ ingredienteId, cantidad });
        }
  prod.receta = nuevaReceta;
  prod.costo = computeRecipeCost(nuevaReceta);
  if(typeof saveProductToFirestore === 'function') saveProductToFirestore(prod);
  // Recalcular subproductos derivados si existen
  try{ recomputeDerivedChildren(prod.id, 8); }catch(_){ }
  saveLS(); renderAll(); renderPosProductList(); closeModal();
      });
    }

    function addToOrder(productoId){
      const p = appState.productos.find(x=>x.id===productoId);
      if(!p) return;
      // Buscar item sin modificadores para merge rápido
      const existing = currentOrder.items.find(i=>i.productoId===productoId && (!i.modifiers || i.modifiers.length===0));
      if(existing){ existing.cantidad += 1; }
      else { currentOrder.items.push({ lineId: generateId('it'), productoId:p.id, nombre:p.nombre, precio:Number(p.precio)||0, cantidad:1, modifiers: [] }); }
      updateOrderUI();
    }

    // Personalización de producto (extras)
    function openCustomizeProductModal(productoId){
      const p = appState.productos.find(x=>x.id===productoId);
      if(!p){ alert('Producto no encontrado'); return; }
      // Construir modal manualmente para lograr un diseño más rico
      const backdrop = $('#modal-backdrop');
      const container = $('#modal-container');
      if(!backdrop || !container){ alert('Modal no disponible'); return; }
      const extras = [
        { key:'papas', label:'Papás', price:20 },
        { key:'carneExtra', label:'Carne extra', price:30 },
        { key:'tocinoExtra', label:'Tocino extra', price:15 },
        { key:'americanoExtra', label:'Queso americano extra', price:5 },
        { key:'manchegoExtra', label:'Queso manchego extra', price:15 },
        { key:'botecitoQueso', label:'Botecito de queso extra', price:5 },
        { key:'chilesExtra', label:'Bote de chiles extra (gratis, máx. 1)', price:0 }
      ];
      const html = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl overflow-hidden">
          <div class="modal-header-nice">
            <h3 class="text-lg font-extrabold">Personalizar: ${p.nombre}</h3>
          </div>
          <div class="p-5 space-y-4">
            <div class="summary-row">
              <div class="font-bold">Precio base</div>
              <div class="price-chip">${fmt(p.precio)}</div>
            </div>
            <div class="summary-row">
              <div class="font-bold">Extras seleccionados</div>
              <div id="mod-extra-sum" class="price-chip">$0.00</div>
            </div>
            <div class="summary-row border-t pt-2">
              <div class="text-xl font-extrabold">Total</div>
              <div id="mod-total" class="text-xl font-extrabold">${fmt(p.precio)}</div>
            </div>
            <div class="opt-grid" id="opt-grid"></div>
            <div class="flex gap-2 pt-2">
              <button id="mod-add" class="btn-success px-4 py-2 rounded flex-1">Agregar a la orden</button>
              <button id="mod-cancel" class="btn-danger px-4 py-2 rounded">Cancelar</button>
            </div>
          </div>
        </div>`;
      container.innerHTML = html;
      backdrop.classList.remove('hidden');
      container.classList.remove('hidden');

      const grid = $('#opt-grid');
      const selected = new Set();
      function renderOptions(){
        grid.innerHTML='';
        extras.forEach(ex=>{
          const card = document.createElement('div');
          card.className = 'opt-card';
          card.innerHTML = `<div class="opt-info"><span>${ex.label}</span><span class="price-chip">${fmt(ex.price)}</span></div><div class="opt-check">${selected.has(ex.key)?'✓':''}</div>`;
          if(selected.has(ex.key)) card.classList.add('selected');
          card.addEventListener('click', ()=>{
            if(ex.key==='chilesExtra'){
              // toggle simple (máx. 1 por ítem)
              if(selected.has(ex.key)) selected.delete(ex.key); else selected.add(ex.key);
            } else {
              if(selected.has(ex.key)) selected.delete(ex.key); else selected.add(ex.key);
            }
            updateTotals(); renderOptions();
          });
          grid.appendChild(card);
        });
      }
      function updateTotals(){
        const sum = extras.filter(e=> selected.has(e.key)).reduce((a,e)=> a + e.price, 0);
        $('#mod-extra-sum').textContent = fmt(sum);
        $('#mod-total').textContent = fmt((Number(p.precio)||0) + sum);
      }
      renderOptions(); updateTotals();

      $('#mod-cancel')?.addEventListener('click', closeModal);
      $('#mod-add')?.addEventListener('click', ()=>{
        const mods = extras.filter(e=> selected.has(e.key)).map(e=> ({ name:e.label, price:e.price }));
        // Merge por mismo set de modificadores
        const keyFrom = (ms)=> ms.map(m=>`${m.name}|${m.price}`).sort().join(';');
        const newKey = keyFrom(mods);
        const existing = currentOrder.items.find(i=> i.productoId===productoId && keyFrom(i.modifiers||[])===newKey);
        if(existing){ existing.cantidad += 1; }
        else{
          currentOrder.items.push({ lineId: generateId('it'), productoId: p.id, nombre: p.nombre, precio: Number(p.precio)||0, cantidad: 1, modifiers: mods });
        }
        closeModal();
        updateOrderUI();
      });
    }

    function changeQty(lineId, delta){
      const it = currentOrder.items.find(i=>i.lineId===lineId);
      if(!it) return;
      it.cantidad += delta;
      if(it.cantidad<=0){ currentOrder.items = currentOrder.items.filter(i=>i.lineId!==lineId); }
      updateOrderUI();
    }
    function removeFromOrder(lineId){
      currentOrder.items = currentOrder.items.filter(i=>i.lineId!==lineId);
      updateOrderUI();
    }

    function updateOrderUI(){
      const box = document.getElementById('pos-order-items');
      const btn = document.getElementById('pos-pay-btn') || document.getElementById('process-sale-btn');
      if(!box) return;
      box.innerHTML='';
      if(currentOrder.items.length===0){
        box.innerHTML = '<div class="text-center py-6 text-sm opacity-70">Añade productos para empezar</div>';
        if(btn) btn.disabled = true;
      } else {
        currentOrder.items.forEach(it=>{
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between border-b py-2';
      const unit = getItemUnitPrice(it);
      const modsText = (it.modifiers && it.modifiers.length>0) ? it.modifiers.map(m=> `${m.name}${m.price?` (+${fmt(m.price)})`:''}`).join(', ') : '';
      row.innerHTML = `
            <div>
              <div class="font-bold">${it.nombre}</div>
        ${modsText? `<div class="text-xs opacity-70">${modsText}</div>`:''}
        <div class="text-xs opacity-70">${fmt(unit)} c/u</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn-danger px-2 py-1 rounded text-sm">-</button>
              <span class="w-8 text-center font-bold">${it.cantidad}</span>
              <button class="btn-success px-2 py-1 rounded text-sm">+</button>
              <button class="btn-danger px-2 py-1 rounded text-sm">×</button>
            </div>
          `;
          const btns = row.querySelectorAll('button');
          const btnMinus = btns[0];
          const btnPlus = btns[1];
          const btnRemove = btns[2];
      if(btnMinus) btnMinus.addEventListener('click', ()=> changeQty(it.lineId,-1));
      if(btnPlus) btnPlus.addEventListener('click', ()=> changeQty(it.lineId, 1));
      if(btnRemove) btnRemove.addEventListener('click', ()=> removeFromOrder(it.lineId));
          box.appendChild(row);
        });
  if(btn) btn.disabled = false;
      }
      updateOrderTotals();
    }

    function getItemUnitPrice(it){
      const base = Number(it.precio)||0;
      const mods = Array.isArray(it.modifiers)? it.modifiers.reduce((a,m)=> a + (Number(m.price)||0), 0) : 0;
      return base + mods;
    }
    function updateOrderTotals(){
      const subtotal = currentOrder.items.reduce((s,i)=> s + getItemUnitPrice(i)*i.cantidad, 0);
      const discount = parseFloat(document.getElementById('pos-discount-input')?.value||'0')||0;
      const shippingEnabled = document.getElementById('pos-shipping-checkbox')?.checked;
      const shipping = shippingEnabled ? (parseFloat(document.getElementById('pos-shipping-cost')?.value||'0')||0) : 0;
      currentOrder.subtotal = subtotal;
      currentOrder.descuento = discount;
      currentOrder.costoEnvio = shipping;
      currentOrder.total = Math.max(0, subtotal - discount + shipping);
      const subtotalEl = document.getElementById('pos-subtotal');
      const totalEl = document.getElementById('pos-total');
      if(subtotalEl) subtotalEl.textContent = fmt(subtotal);
      if(totalEl) totalEl.textContent = fmt(currentOrder.total);
    }

    function wirePosInputs(){
      document.getElementById('pos-discount-input')?.addEventListener('input', updateOrderTotals);
      document.getElementById('pos-search-input')?.addEventListener('input', renderPosProductList);
      // Categorías
      document.querySelectorAll('.pos-cat-btn')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          posCategoryFilter = btn.getAttribute('data-pos-cat')||'all';
          document.querySelectorAll('.pos-cat-btn').forEach(b=> b.classList.remove('bg-white'));
          btn.classList.add('bg-white');
          renderPosProductList();
        });
      });
      document.getElementById('pos-order-type')?.addEventListener('change', (e)=>{
        currentOrder.tipo = e.target.value;
        const shipChk = document.getElementById('pos-shipping-checkbox');
        const shipCost = document.getElementById('pos-shipping-cost');
        if(currentOrder.tipo==='envio'){
          shipChk?.removeAttribute('disabled');
        } else {
          if(shipChk){ shipChk.checked=false; }
          shipCost?.classList.add('hidden');
          shipCost && (shipCost.value='');
          updateOrderTotals();
        }
      });
      document.querySelectorAll('[data-discount-pct]')?.forEach(btn=> btn.addEventListener('click', ()=>{
        const pct = Number(btn.getAttribute('data-discount-pct'))||0;
        const calc = Math.round((currentOrder.subtotal * pct)/100*100)/100;
        const input = document.getElementById('pos-discount-input'); if(input){ input.value = String(calc); }
        updateOrderTotals();
      }));
      const shipChk = document.getElementById('pos-shipping-checkbox');
      const shipCost = document.getElementById('pos-shipping-cost');
      shipChk?.addEventListener('change', ()=>{
        if(shipChk.checked){ shipCost.classList.remove('hidden'); }
        else { shipCost.classList.add('hidden'); shipCost.value=''; }
        updateOrderTotals();
      });
      shipCost?.addEventListener('input', updateOrderTotals);
      document.getElementById('process-sale-btn')?.addEventListener('click', openPayModal);
      document.getElementById('pos-pay-btn')?.addEventListener('click', openPayModal);
      document.getElementById('pos-clear-btn')?.addEventListener('click', ()=>{ currentOrder.items=[]; updateOrderUI(); });
      document.getElementById('pos-suspend-btn')?.addEventListener('click', ()=>{
        if(currentOrder.items.length===0){ alert('No hay productos en la orden'); return; }
        const copy = JSON.parse(JSON.stringify(currentOrder));
        copy.id = generateId('susp');
        suspendedOrders.push(copy);
  if(typeof savePedidoToFirestore==='function') savePedidoToFirestore({ id: copy.id, ventaId: null, clienteId: copy.clienteId||null, estado:'pendiente', fecha: new Date().toISOString() });
        currentOrder = { items: [], clienteId: null, subtotal: 0, total: 0, descuento: 0, costoEnvio: 0, tipo:'local', pago:null };
        updateOrderUI();
        alert('Orden suspendida');
      });
      document.getElementById('pos-suspended-list-btn')?.addEventListener('click', ()=>{
        if(suspendedOrders.length===0){ alert('No hay órdenes guardadas'); return; }
        const options = suspendedOrders.map((o,idx)=> `${idx+1}. ${o.items.length} items - ${fmt(o.total)}`).join('\n');
        const pick = prompt(`Órdenes guardadas:\n${options}\nIngresa número para reanudar:`);
        const i = (Number(pick)||0)-1; if(i<0 || i>=suspendedOrders.length) return;
        currentOrder = suspendedOrders.splice(i,1)[0];
        updateOrderUI();
      });
      document.getElementById('pos-add-customer')?.addEventListener('click', openClienteModal);
    }

    function openPayModal(){
      if(currentOrder.items.length===0){ alert('No hay productos en la orden'); return; }
      openFormModal({
        title:'Cobrar',
        fields:[
          {name:'metodo', label:'Método de pago', type:'text', placeholder:'Efectivo, Tarjeta, Transferencia'},
          {name:'referencia', label:'Referencia (opcional)', type:'text', placeholder:'Folio/últimos 4/etc'}
        ],
        submitText:'Confirmar cobro',
        onSubmit:(data)=>{
          currentOrder.pago = { metodo: (data.metodo||'').trim()||'Efectivo', referencia: (data.referencia||'').trim() };
          processSale();
        }
      });
    }

    function processSale(){
      if(currentOrder.items.length===0){ alert('No hay productos en la orden'); return; }
      const sel = document.getElementById('pos-customer-select');
      const clienteId = sel && sel.value ? sel.value : null;
      // Asignar número de venta secuencial
      if(typeof appState.nextSaleNumber !== 'number' || appState.nextSaleNumber < 1){ appState.nextSaleNumber = 1; }
      const saleNumber = appState.nextSaleNumber++;
      const venta = {
        id: generateId('sale'),
        fecha: new Date().toISOString(),
        clienteId,
  tipo: currentOrder.tipo,
  pago: currentOrder.pago,
        saleNumber,
        items: JSON.parse(JSON.stringify(currentOrder.items)),
        subtotal: currentOrder.subtotal,
        descuento: currentOrder.descuento,
        costoEnvio: currentOrder.costoEnvio,
        total: currentOrder.total
      };
      appState.ventas.push(venta);
  if(typeof saveVentaToFirestore==='function') try{ saveVentaToFirestore(venta); }catch(_){ }
  // insumos consumidos por esta venta
  accumulateInsumosFromVenta(venta);
  renderInventario();
      // puntos del cliente
      if(clienteId){
        const c = appState.clientes.find(x=>x.id===clienteId);
        if(c){
          c.gastoTotal = (c.gastoTotal||0) + currentOrder.total;
          // 1 punto por cada $10 gastados
          c.puntos = (c.puntos||0) + Math.floor(currentOrder.total / 10);
        }
      }
      // Añadir a pendientes (cola simple)
  const pedido = { id: generateId('ord'), ventaId: venta.id, clienteId, estado:'pendiente', fecha: venta.fecha };
  appState.pedidosPendientes.push(pedido);
  if(typeof savePedidoToFirestore==='function') savePedidoToFirestore(pedido);
      // limpiar orden
      currentOrder = { items: [], clienteId: null, subtotal: 0, total: 0, descuento: 0, costoEnvio: 0 };
      document.getElementById('pos-discount-input').value = '';
      const scb = document.getElementById('pos-shipping-checkbox');
      const sc = document.getElementById('pos-shipping-cost');
      if(scb){ scb.checked = false; }
      if(sc){ sc.value=''; sc.classList.add('hidden'); }
      if(sel) sel.value = '';
  if(typeof saveInsumosToFirestore==='function') saveInsumosToFirestore();
  if(typeof saveMetaToFirestore==='function') saveMetaToFirestore();
  saveLS(); renderAll(); renderPosProductList(); renderPedidosPendientes();
      alert('Venta procesada correctamente');
    }

    function renderPedidosPendientes(){
      const cont = document.getElementById('pedidos-pendientes-container');
      const countEl = document.getElementById('pedidos-count');
      const noMsg = document.getElementById('no-pedidos-message');
      if(!cont) return;
      cont.innerHTML='';
      const list = appState.pedidosPendientes||[];
      countEl && (countEl.textContent = String(list.length));
      if(list.length===0){ noMsg?.classList.remove('hidden'); return; }
      noMsg?.classList.add('hidden');
      list.forEach(p=>{
        const cli = appState.clientes.find(c=>c.id===p.clienteId);
        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl shadow bg-white/80';
        card.innerHTML = `
          <div class="font-bold">Pedido #${String(p.id).slice(0,6)}</div>
          <div class="text-sm opacity-70">${new Date(p.fecha).toLocaleString()}</div>
          <div class="mt-2">Cliente: ${cli?cli.nombre:'General'}</div>
          <div class="mt-2 flex gap-2">
            <button class="btn-success px-3 py-1 rounded text-sm">Listo</button>
            <button class="btn-danger px-3 py-1 rounded text-sm">Cancelar</button>
          </div>
        `;
        const [btnOk, btnCancel] = card.querySelectorAll('button');
  btnOk.addEventListener('click', ()=>{ appState.pedidosPendientes = appState.pedidosPendientes.filter(x=>x.id!==p.id); if(typeof deletePedidoFromFirestore==='function') deletePedidoFromFirestore(p.id); saveLS(); renderPedidosPendientes(); });
  btnCancel.addEventListener('click', ()=>{ appState.pedidosPendientes = appState.pedidosPendientes.filter(x=>x.id!==p.id); if(typeof deletePedidoFromFirestore==='function') deletePedidoFromFirestore(p.id); saveLS(); renderPedidosPendientes(); });
        cont.appendChild(card);
      });
    }

    // --- Helper: Crear/actualizar producto con receta por nombres de ingredientes ---
  function addOrUpdateProductWithRecipe({ nombre, precio, descripcion, receta }){
      try{
        if(!nombre || !Array.isArray(receta)) return;
    const byName = (n)=> (n||'').toString().trim().toLowerCase();
        // Mapear nombres de ingredientes a IDs
        const mappedReceta = [];
        for(const item of receta){
          const ing = (appState.ingredientes||[]).find(i=> byName(i.nombre) === byName(item.nombre));
          if(!ing){ console.warn('[RECIPE] Ingrediente no encontrado:', item.nombre); continue; }
          const cantidad = Number(item.cantidad)||0;
          if(cantidad<=0) continue;
          mappedReceta.push({ ingredienteId: ing.id, cantidad });
        }
        // Buscar producto existente por nombre
        // Preferir existente no archivado; si sólo hay archivado, reutilizar y desarchivar
        const sameName = (appState.productos||[]).filter(p=> byName(p.nombre) === byName(nombre));
        const existing = sameName.find(p=> !p.archivado) || sameName[0];
        if(existing){
          if(existing.archivado){ existing.archivado=false; existing.archivedAt=undefined; }
          if(typeof precio === 'number' && !Number.isNaN(precio)) existing.precio = precio;
          if(descripcion!=null) existing.descripcion = descripcion;
          if(mappedReceta.length>0) existing.receta = mappedReceta;
          existing.costo = computeRecipeCost(existing.receta||[]);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(existing);
        } else {
          const costo = computeRecipeCost(mappedReceta);
          const nuevo = { id: generateId('p'), nombre, precio: Number(precio)||0, descripcion: descripcion||'', receta: mappedReceta, costo };
          appState.productos.push(nuevo);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(nuevo);
        }
        saveLS();
        renderAll();
        renderPosProductList();
      }catch(e){ console.error('addOrUpdateProductWithRecipe error', e); }
    }

    // Actualizar receta por nombre exacto (útil cuando hay productos con el mismo nombre en distinto case)
    function updateProductRecipeExact({ nombre, precio, descripcion, receta }){
      try{
        const exact = (appState.productos||[]).find(p=> (p.nombre||'') === nombre);
        const byName = (n)=> (n||'').toString().trim().toLowerCase();
        const mapReceta = (arr)=>{
          const out = [];
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> byName(i.nombre)===byName(item.nombre));
            if(!ing) return;
            const cantidad = Number(item.cantidad)||0; if(cantidad<=0) return;
            out.push({ ingredienteId: ing.id, cantidad });
          });
          return out;
        };
        if(exact){
          if(typeof precio==='number' && !Number.isNaN(precio)) exact.precio = precio;
          if(descripcion!=null) exact.descripcion = descripcion;
          exact.receta = mapReceta(receta);
          exact.costo = computeRecipeCost(exact.receta||[]);
          if(typeof saveProductToFirestore === 'function') saveProductToFirestore(exact);
          saveLS(); renderAll();
        } else {
          // Si no existe exacto, usar el helper general (case-insensitive)
          addOrUpdateProductWithRecipe({ nombre, precio, descripcion, receta });
        }
      }catch(e){ console.warn('updateProductRecipeExact', e); }
    }

    // Subproducto: derivar receta a partir de un producto padre dividiendo cantidades por un divisor (default 8)
  function deriveSubProductFrom(parentId, { childName, divisor=8, priceStrategy='divide' }){
      try{
        const parent = (appState.productos||[]).find(p=>p.id===parentId);
        if(!parent){ alert('Producto padre no encontrado'); return; }
        const recetaPadre = Array.isArray(parent.receta) ? parent.receta : [];
        if(recetaPadre.length===0){ alert('El producto padre no tiene receta'); return; }
        const div = Number(divisor)||8;
        const childReceta = recetaPadre.map(r=> ({ ingredienteId: r.ingredienteId, cantidad: (Number(r.cantidad)||0)/div }));
        const targetName = (childName && childName.trim()) ? childName.trim() : `Rebanada de ${parent.nombre}`;
        // Buscar si ya existe un hijo por nombre o vínculo parentId
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
  let child = (appState.productos||[]).find(p=> (p.parentId===parent.id && byName(p.nombre)===byName(targetName)) || byName(p.nombre)===byName(targetName));
        const computePrice = ()=>{
          if(priceStrategy==='divide') return Number(((Number(parent.precio)||0)/div).toFixed(2));
          return Number(child?.precio||0) || 0;
        };
        if(child){
          child.nombre = targetName;
          child.receta = childReceta;
          child.parentId = parent.id;
          child.derivedDivisor = div;
          child.precio = computePrice();
          child.descripcion = child.descripcion || ((parent.descripcion||'') + ' (rebanada)');
          child.costo = computeRecipeCost(child.receta||[]);
          if(typeof saveProductToFirestore==='function') saveProductToFirestore(child);
        }else{
          child = {
            id: generateId('p'),
            nombre: targetName,
            precio: computePrice(),
            descripcion: (parent.descripcion||'') + ' (rebanada)',
            receta: childReceta,
            parentId: parent.id,
            derivedDivisor: div,
            costo: 0
          };
          child.costo = computeRecipeCost(child.receta||[]);
          appState.productos.push(child);
          if(typeof saveProductToFirestore==='function') saveProductToFirestore(child);
        }
        saveLS(); renderAll(); renderPosProductList();
        alert(`Subproducto listo: ${child.nombre}`);
        return child;
      }catch(e){ console.warn('deriveSubProductFrom', e); alert('No se pudo derivar el subproducto'); }
    }

    // Recalcular automáticamente los subproductos cuando cambie la receta del padre
  function recomputeDerivedChildren(parentId, divisor=8){
      try{
        const parent = (appState.productos||[]).find(p=>p.id===parentId);
        if(!parent) return;
        const childs = (appState.productos||[]).filter(p=> p.parentId===parentId);
        if(childs.length===0) return;
        const div = Number(divisor)||8;
        const base = Array.isArray(parent.receta)? parent.receta : [];
        childs.forEach(ch=>{
          const d = Number(ch.derivedDivisor)||div;
          ch.receta = base.map(r=> ({ ingredienteId:r.ingredienteId, cantidad:(Number(r.cantidad)||0)/d }));
          ch.costo = computeRecipeCost(ch.receta||[]);
          // Mantener precio actual a menos que esté configurado para dividir; aquí respetamos el existente
          if(typeof saveProductToFirestore==='function') saveProductToFirestore(ch);
        });
        saveLS(); renderAll();
      }catch(e){ console.warn('recomputeDerivedChildren', e); }
    }

    // Reaplicar receta para cualquier variante con nombre "HAMBURGUESA DOBLE" (case-insensitive)
    function ensureHamburguesaDobleRecipe(){
      try{
        const target = 'hamburguesa doble';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'QUESO MANCHEGO', cantidad:50 },
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales', cantidad:1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad:2 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'QUESO AMERICANO', cantidad:1 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'BIMBOLLO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            // Preservar precio si ya tiene; forzar 130 si no
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 130;
            if(!p.descripcion) p.descripcion = 'Hamburguesa doble carne con queso manchego, tocino y vegetales.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHamburguesaDobleRecipe', e); }
    }

    // Reaplicar receta para cualquier variante con nombre "HAMBURGUESA BBQ" (case-insensitive)
    function ensureHamburguesaBBQRecipe(){
      try{
        const target = 'hamburguesa bbq';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales', cantidad:1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad:1 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'QUESO AMERICANO', cantidad:1 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'BIMBOLLO', cantidad:1 },
          { nombre:'SALSA BBQ', cantidad:30 },
          { nombre:'AROS DE CEBOLLA', cantidad:3 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 110;
            if(!p.descripcion) p.descripcion = 'Hamburguesa con salsa BBQ, tocino y vegetales.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHamburguesaBBQRecipe', e); }
    }

    // Reaplicar receta para "HAMBURGUESA BBQ DOBLE" (case-insensitive)
    function ensureHamburguesaBBQDobleRecipe(){
      try{
        const target = 'hamburguesa bbq doble';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales', cantidad:1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad:2 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'QUESO AMERICANO', cantidad:2 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'BIMBOLLO', cantidad:1 },
          { nombre:'SALSA BBQ', cantidad:30 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 140;
            if(!p.descripcion) p.descripcion = 'Hamburguesa doble carne con salsa BBQ, tocino y vegetales.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHamburguesaBBQDobleRecipe', e); }
    }

    // Reaplicar receta para "PAPAS GAJO complemento" (case-insensitive)
    function ensurePapasGajoComplementoRecipe(){
      try{
        const target = 'papas gajo complemento';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS GAJO', cantidad:140 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 20;
            if(!p.descripcion) p.descripcion = 'Porción de papas gajo con queso nachos.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasGajoComplementoRecipe', e); }
    }

    // Reaplicar receta para "PAPAS FRANCESAS complemento" (case-insensitive)
    function ensurePapasFrancesasComplementoRecipe(){
      try{
        const target = 'papas francesas complemento';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS FRANCESAS', cantidad:140 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 20;
            if(!p.descripcion) p.descripcion = 'Porción de papas francesas con queso nachos.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasFrancesasComplementoRecipe', e); }
    }

    // Reaplicar receta para "PAPAS GAJO MEDIANAS" (case-insensitive)
    function ensurePapasGajoMedianasRecipe(){
      try{
        const target = 'papas gajo medianas';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS GAJO', cantidad:280 },
          { nombre:'CHAROLA PEQUEÑA', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            if(!p.descripcion) p.descripcion = 'Papas gajo medianas con queso nachos en charola.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasGajoMedianasRecipe', e); }
    }

    // Reaplicar receta para "PAPAS FRANCESAS MEDIANAS" (case-insensitive)
    function ensurePapasFrancesasMedianasRecipe(){
      try{
        const target = 'papas francesas medianas';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS FRANCESAS', cantidad:280 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:35 },
          { nombre:'CHAROLA PEQUEÑA', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            if(!p.descripcion) p.descripcion = 'Papas francesas medianas con queso nachos en charola.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasFrancesasMedianasRecipe', e); }
    }

    // Reaplicar receta para "PAPAS GAJO GRANDES" (case-insensitive)
    function ensurePapasGajoGrandesRecipe(){
      try{
        const target = 'papas gajo grandes';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS GAJO', cantidad:560 },
          { nombre:'BOTECITO', cantidad:2 },
          { nombre:'QUESO NACHOS', cantidad:75 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 120;
            if(!p.descripcion) p.descripcion = 'Papas gajo grandes con queso nachos en charola grande.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasGajoGrandesRecipe', e); }
    }

    // Reaplicar receta para "PAPAS FRANCESAS GRANDES" (case-insensitive)
    function ensurePapasFrancesasGrandesRecipe(){
      try{
        const target = 'papas francesas grandes';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAPAS FRANCESAS', cantidad:560 },
          { nombre:'BOTECITO', cantidad:2 },
          { nombre:'QUESO NACHOS', cantidad:75 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 120;
            if(!p.descripcion) p.descripcion = 'Papas francesas grandes con queso nachos en charola grande.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensurePapasFrancesasGrandesRecipe', e); }
    }

    // Reaplicar receta para "HOTDOG JUMBO"
    function ensureHotdogJumboRecipe(){
      try{
        const target = 'hotdog jumbo';
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales Hotdog', cantidad:1 },
          { nombre:'SALCHICHAS JUMBO', cantidad:1 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'PAN HOTDOG', cantidad:1 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'QUESO NACHOS', cantidad:15 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(byName(p.nombre)===target){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            if(!p.descripcion) p.descripcion = 'Hotdog jumbo con tocino, vegetales y queso nachos.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHotdogJumboRecipe', e); }
    }

    // Reaplicar receta para "HOT DOG SALCHIROJA" (case-insensitive)
    function ensureHotdogSalchirojaRecipe(){
      try{
        const targets = ['hot dog salchiroja','hotdog salchicha roja'];
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        const receta = [
          { nombre:'PAN HOTDOG MEDIA NOCHE', cantidad:1 },
          { nombre:'SALCHICHA BAFAR JALAPEÑO', cantidad:1 },
          { nombre:'Vegetales Hotdog', cantidad:1 },
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'QUESO MANCHEGO', cantidad:30 },
          { nombre:'CHAROLA PEQUEÑA', cantidad:1 },
          { nombre:'PAPEL GRADO ALIMENTICIO', cantidad:1 },
          { nombre:'Catsup', cantidad:1 }
        ];
        const mapReceta = (arr)=>{
          const out=[]; const ln = (x)=> (x||'').toLowerCase();
          (arr||[]).forEach(item=>{
            const ing = (appState.ingredientes||[]).find(i=> ln(i.nombre)===ln(item.nombre));
            if(!ing) return; const cant=Number(item.cantidad)||0; if(cant<=0) return; out.push({ ingredienteId: ing.id, cantidad:cant });
          });
          return out;
        };
        let changed = false;
        (appState.productos||[]).forEach(p=>{
          if(targets.includes(byName(p.nombre))){
            if(typeof p.precio !== 'number' || Number.isNaN(p.precio)) p.precio = 60;
            // Mantener descripción existente si ya tiene; si no, usar una genérica
            if(!p.descripcion) p.descripcion = 'Hot dog salchicha roja con jalapeño, tocino y queso.';
            p.receta = mapReceta(receta);
            p.costo = computeRecipeCost(p.receta||[]);
            if(typeof saveProductToFirestore === 'function') saveProductToFirestore(p);
            changed = true;
          }
        });
        if(changed){ saveLS(); renderAll(); }
      }catch(e){ console.warn('ensureHotdogSalchirojaRecipe', e); }
    }

    // Garantizar la presencia de los productos solicitados (precio + descripción, receta vacía)
    function ensureRequestedProducts(){
      try{
        const want = [
          { nombre:'HAMBURGUESA DOBLE', precio:130, descripcion:'Hamburguesa doble carne con queso manchego, tocino y vegetales.', categoria:'Hamburguesas' },
          { nombre:'HAMBURGUESA BBQ', precio:110, descripcion:'Hamburguesa con salsa BBQ, tocino y vegetales.', categoria:'Hamburguesas' },
          { nombre:'HAMBURGUESA BBQ DOBLE', precio:140, descripcion:'Hamburguesa doble carne con salsa BBQ, tocino y vegetales.', categoria:'Hamburguesas' },
          { nombre:'PAPAS GAJO complemento', precio:20, descripcion:'Porción de papas gajo con queso nachos.', categoria:'Complementos' },
          { nombre:'PAPAS FRANCESAS complemento', precio:20, descripcion:'Porción de papas francesas con queso nachos.', categoria:'Complementos' },
          { nombre:'PAPAS GAJO MEDIANAS', precio:60, descripcion:'Papas gajo medianas con queso nachos en charola.', categoria:'Complementos' },
          { nombre:'PAPAS FRANCESAS MEDIANAS', precio:60, descripcion:'Papas francesas medianas con queso nachos en charola.', categoria:'Complementos' },
          { nombre:'PAPAS GAJO GRANDES', precio:120, descripcion:'Papas gajo grandes con queso nachos en charola grande.', categoria:'Complementos' },
          { nombre:'PAPAS FRANCESAS GRANDES', precio:120, descripcion:'Papas francesas grandes con queso nachos en charola grande.', categoria:'Complementos' },
          { nombre:'HOTDOG JUMBO', precio:60, descripcion:'Hot dog jumbo con salchicha jumbo, tocino, vegetales y queso nachos.', categoria:'Hotdogs' },
          { nombre:'HOT DOG SALCHIROJA', precio:60, descripcion:'Hot dog con salchicha roja , jalapeño, queso gouda y tocino.', categoria:'Hotdogs' }
        ];
        const byName = (s)=> (s||'').toString().trim().toLowerCase();
        want.forEach(p=>{
          const existObj = (appState.productos||[]).find(x=> byName(x.nombre)===byName(p.nombre));
          if(!existObj){ addOrUpdateProductWithRecipe({ ...p, receta: [] }); }
          else if(!existObj.categoria && p.categoria){ existObj.categoria = p.categoria; }
        });
      }catch(e){ console.warn('ensureRequestedProducts', e); }
    }

    // Charts
    let salesChart, productsChart;
    function renderCharts(){
      // Tweak Chart defaults on small screens
      try{
        if(window.Chart){
          const small = window.matchMedia('(max-width: 640px)').matches;
          Chart.defaults.font.size = small ? 10 : 12;
          Chart.defaults.plugins.legend.labels.boxWidth = small ? 10 : 12;
        }
      }catch(_){ }
      const period = document.getElementById('rep-period-select')?.value || '30d';
      const filterType = document.getElementById('rep-filter-type')?.value || 'all';
      const filterPay = document.getElementById('rep-filter-pay')?.value || 'all';
      let now = new Date();
      let start = new Date(now);
      if(period==='today'){ start.setHours(0,0,0,0); }
      else if(period==='30d'){ start.setDate(start.getDate()-30); }
      else if(period==='month'){ start = new Date(now.getFullYear(), now.getMonth(), 1); }
      else if(period==='all'){ start = new Date(0); }
      else if(period==='custom'){
        const s = document.getElementById('rep-date-start')?.value;
        const e = document.getElementById('rep-date-end')?.value;
        start = s ? new Date(s+'T00:00:00') : new Date(0);
        now = e ? new Date(e+'T23:59:59') : new Date();
      } else { start.setDate(start.getDate()-7); }
      const ventas = (appState.ventas||[]).filter(v=>{
        if(v?.cancelada) return false;
        const d = new Date(v.fecha);
        if(!(d>=start && d<=now)) return false;
        if(filterType!=='all' && (v.tipo||'local')!==filterType) return false;
        const m = v.pago?.metodo || 'Efectivo';
        if(filterPay!=='all' && m!==filterPay) return false;
        return true;
      });

      // KPIs
      const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
      const revenue = sum(ventas, v=> v.total||0);
      const orders = ventas.length;
      const items = sum(ventas, v=> sum(v.items||[], it=> it.cantidad||0));
      const aov = orders>0 ? revenue/orders : 0;
      // Margen bruto estimado = ventas - costo receta
      const prodLookup = new Map((uniqueByProductName? uniqueByProductName(appState.productos||[]): (appState.productos||[])).map(p=>[p.id,p]));
      const estCost = sum(ventas, v=> sum(v.items||[], it=>{
        const prod = prodLookup.get(it.productoId) || appState.productos.find(p=>p.id===it.productoId);
        const cost = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
        return (cost || 0) * (it.cantidad||0);
      }));
      const gp = Math.max(0, revenue - estCost);
      const setTxt = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = txt; };
      setTxt('rep-revenue', fmt(revenue));
      setTxt('rep-orders', String(orders));
      setTxt('rep-aov', fmt(aov));
      setTxt('rep-gp', fmt(gp));

      // Charts
  const salesCtx = document.getElementById('sales-chart')?.getContext('2d');
  const prodCtx = document.getElementById('products-chart')?.getContext('2d');
  const typeCtx = document.getElementById('order-type-chart')?.getContext('2d');
  const payCtx = document.getElementById('payment-method-chart')?.getContext('2d');
  const weekCtx = document.getElementById('weekday-chart')?.getContext('2d');
  const topCliCtx = document.getElementById('top-clients-chart')?.getContext('2d');
  const marginCtx = document.getElementById('margin-chart')?.getContext('2d');
  const hourlyCtx = document.getElementById('hourly-report-chart')?.getContext('2d');
      if(salesChart){ salesChart.destroy(); salesChart = undefined; }
      if(productsChart){ productsChart.destroy(); productsChart = undefined; }
  if(window.__typeChart){ window.__typeChart.destroy(); window.__typeChart = undefined; }
  if(window.__payChart){ window.__payChart.destroy(); window.__payChart = undefined; }
  if(window.__weekChart){ window.__weekChart.destroy(); window.__weekChart = undefined; }
  if(window.__topCliChart){ window.__topCliChart.destroy(); window.__topCliChart = undefined; }
  if(window.__marginChart){ window.__marginChart.destroy(); window.__marginChart = undefined; }
  if(window.__hourlyRepChart){ window.__hourlyRepChart.destroy(); window.__hourlyRepChart = undefined; }

      if (salesCtx) {
        const byDay = {};
        ventas.forEach(v=>{ const k = new Date(v.fecha).toISOString().slice(0,10); byDay[k] = (byDay[k]||0) + (v.total||0); });
        const labelsSales = Object.keys(byDay).sort();
        salesChart = new Chart(salesCtx, {
          type: 'line',
          data: { labels: labelsSales, datasets: [ { label: 'Ventas', data: labelsSales.map(k=>byDay[k]), borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,.2)', tension:.3 } ] },
          options: { responsive: true, plugins: { legend: { display: false } }, scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit: (window.innerWidth<640?5:10) } }, y:{ ticks:{ callback:(v)=>'$'+v } } } }
        });
      }
      if (prodCtx) {
        const counts = {};
        ventas.forEach(v=> (v.items||[]).forEach(it=>{ counts[it.nombre] = (counts[it.nombre]||0) + (it.cantidad||0); }));
        const labelsProducts = Object.keys(counts).sort((a,b)=> counts[b]-counts[a]).slice(0,10);
        productsChart = new Chart(prodCtx, { type: 'bar', data: { labels: labelsProducts, datasets: [ { label: 'Cantidad', data: labelsProducts.map(k=>counts[k]), backgroundColor: '#3B82F6' } ] }, options: { responsive: true, plugins: { legend: { display: false } } } });
      }
      if(typeCtx){
        const byType = { local:0, para_llevar:0, envio:0 };
        ventas.forEach(v=>{ byType[v.tipo||'local'] = (byType[v.tipo||'local']||0) + (v.total||0); });
        window.__typeChart = new Chart(typeCtx, { type:'doughnut', data:{ labels:['Local','Para llevar','Envío'], datasets:[{ data:[byType.local||0, byType.para_llevar||0, byType.envio||0], backgroundColor:['#10B981','#F59E0B','#3B82F6'] }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });
      }
      if(payCtx){
        const byPay = {};
        ventas.forEach(v=>{ const m=v.pago?.metodo||'Efectivo'; byPay[m]=(byPay[m]||0)+(v.total||0); });
        const labels = Object.keys(byPay);
        window.__payChart = new Chart(payCtx, { type:'pie', data:{ labels, datasets:[{ data: labels.map(k=>byPay[k]), backgroundColor:['#8B4513','#FF6B35','#10B981','#3B82F6','#F59E0B'] }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });
      }
      if(weekCtx){
        const byDay = [0,0,0,0,0,0,0]; // Domingo..Sábado
        ventas.forEach(v=>{ const d=new Date(v.fecha).getDay(); byDay[d] += (v.total||0); });
        window.__weekChart = new Chart(weekCtx, { type:'bar', data:{ labels:['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'], datasets:[{ label:'Ingresos', data:byDay, backgroundColor:'#A855F7' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
      }
      if(topCliCtx){
        const byClient = {};
        ventas.forEach(v=>{ const id=v.clienteId||'general'; byClient[id]=(byClient[id]||0)+(v.total||0); });
        const sorted = Object.entries(byClient).sort((a,b)=> b[1]-a[1]).slice(0,10);
        const labels = sorted.map(([id])=> appState.clientes.find(c=>c.id===id)?.nombre || 'General');
        const values = sorted.map(([,val])=> val);
        window.__topCliChart = new Chart(topCliCtx, { type:'bar', data:{ labels, datasets:[{ label:'Ingresos', data:values, backgroundColor:'#DC143C' }] }, options:{ indexAxis:'y', responsive:true, plugins:{ legend:{ display:false } } } });
      }
      if (marginCtx) {
        const totals = {};
        ventas.forEach(v=> (v.items||[]).forEach(it=>{
          const prod = prodLookup.get(it.productoId) || appState.productos.find(p=>p.id===it.productoId);
          const costUnit = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
          const key = it.nombre;
          if(!totals[key]) totals[key] = { qty:0, revenue:0, cost:0 };
          totals[key].qty += it.cantidad||0;
          totals[key].revenue += (it.precio||0) * (it.cantidad||0);
          totals[key].cost += (costUnit||0) * (it.cantidad||0);
        }));
        const entries = Object.entries(totals).map(([name, t])=> [name, Math.max(0, (t.revenue||0) - (t.cost||0))]);
        const top = entries.sort((a,b)=> b[1]-a[1]).slice(0,10);
        window.__marginChart = new Chart(marginCtx, { type:'bar', data:{ labels: top.map(e=>e[0]), datasets:[{ label:'Margen bruto', data: top.map(e=>e[1]), backgroundColor:'#059669' }] }, options:{ indexAxis:'y', responsive:true, plugins:{ legend:{ display:false } } } });
      }
      if (hourlyCtx) {
        const byHour = new Array(24).fill(0);
        ventas.forEach(v=>{ const d=new Date(v.fecha); byHour[d.getHours()] += (v.total||0); });
        window.__hourlyRepChart = new Chart(hourlyCtx, { type:'line', data:{ labels:[...Array(24)].map((_,h)=> h+':00'), datasets:[{ label:'Ingresos', data:byHour, borderColor:'#2563EB', backgroundColor:'rgba(37,99,235,.15)', tension:.3 }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
      }
    }

    // CSV helpers and export wiring
    function toCSV(rows){
      return rows.map(r=> r.map(v=>{
        if(v===null||v===undefined) return '';
        const s = String(v).replaceAll('"','""');
        return (s.includes(',')||s.includes('"')||s.includes('\n')) ? '"'+s+'"' : s;
      }).join(',')).join('\n');
    }
    function downloadCSV(name, rows){
      try{
        const csv = toCSV(rows);
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=name; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
      }catch(e){ console.warn('downloadCSV', e); }
    }
    function getFilteredVentas(){
      const period = document.getElementById('rep-period-select')?.value || '30d';
      const filterType = document.getElementById('rep-filter-type')?.value || 'all';
      const filterPay = document.getElementById('rep-filter-pay')?.value || 'all';
      let now = new Date();
      let start = new Date(now);
      if(period==='today'){ start.setHours(0,0,0,0); }
      else if(period==='30d'){ start.setDate(start.getDate()-30); }
      else if(period==='month'){ start = new Date(now.getFullYear(), now.getMonth(), 1); }
      else if(period==='all'){ start = new Date(0); }
      else if(period==='custom'){
        const s = document.getElementById('rep-date-start')?.value;
        const e = document.getElementById('rep-date-end')?.value;
        start = s ? new Date(s+'T00:00:00') : new Date(0);
        now = e ? new Date(e+'T23:59:59') : new Date();
      } else { start.setDate(start.getDate()-7); }
      const ventas = (appState.ventas||[]).filter(v=>{
        const d = new Date(v.fecha);
        if(!(d>=start && d<=now)) return false;
        if(filterType!=='all' && (v.tipo||'local')!==filterType) return false;
        const m = v.pago?.metodo || 'Efectivo';
        if(filterPay!=='all' && m!==filterPay) return false;
        return true;
      });
      return ventas;
    }
    function exportSalesCSV(){
      const ventas = getFilteredVentas();
      const rows = [['ID','Fecha','Cliente','Tipo','Pago','Subtotal','Descuento','Envio','Total','Items']];
      ventas.forEach(v=>{
        const cliente = appState.clientes.find(c=>c.id===v.clienteId)?.nombre || 'General';
        const items = (v.items||[]).reduce((s,i)=> s + (i.cantidad||0), 0);
        rows.push([v.id, new Date(v.fecha).toLocaleString(), cliente, v.tipo||'local', v.pago?.metodo||'Efectivo', fmtNum(v.subtotal||0), fmtNum(v.descuento||0), fmtNum(v.costoEnvio||0), fmtNum(v.total||0), items]);
      });
      downloadCSV('ventas.csv', rows);
    }
    function exportProductsCSV(){
      const ventas = getFilteredVentas();
      const agg = {};
  ventas.forEach(v=> (v.items||[]).forEach(it=>{
  const key = it.nombre;
  const prod = prodLookup.get(it.productoId) || appState.productos.find(p=>p.id===it.productoId);
        const costUnit = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
        if(!agg[key]) agg[key] = { qty:0, revenue:0, cost:0 };
        agg[key].qty += it.cantidad||0;
        agg[key].revenue += (it.precio||0) * (it.cantidad||0);
        agg[key].cost += (costUnit||0) * (it.cantidad||0);
      }));
      const rows = [['Producto','Cantidad','Ingresos','Costo Est.','Margen Est.']];
      Object.entries(agg).forEach(([name, t])=>{
        const margin = Math.max(0, (t.revenue||0)-(t.cost||0));
        rows.push([name, t.qty, fmtNum(t.revenue||0), fmtNum(t.cost||0), fmtNum(margin)]);
      });
      downloadCSV('productos.csv', rows);
    }
  function exportSummaryCSV(){
      const ventas = getFilteredVentas();
      const sum = (arr,f)=> arr.reduce((s,x)=> s + (f?f(x):x), 0);
      const revenue = sum(ventas, v=> v.total||0);
      const orders = ventas.length;
      const items = sum(ventas, v=> sum(v.items||[], it=> it.cantidad||0));
      const aov = orders>0 ? revenue/orders : 0;
      const estCost = sum(ventas, v=> sum(v.items||[], it=>{
        const prod = appState.productos.find(p=>p.id===it.productoId);
        const cost = (prod && typeof prod.costo==='number') ? prod.costo : computeRecipeCost(prod?.receta||[]);
        return (cost || 0) * (it.cantidad||0);
      }));
      const gp = Math.max(0, revenue - estCost);
      const rows = [
        ['Métrica','Valor'],
        ['Ingresos', fmtNum(revenue)],
        ['Órdenes', orders],
        ['Items', items],
        ['Ticket promedio', fmtNum(aov)],
        ['Margen bruto (est.)', fmtNum(gp)]
      ];
      downloadCSV('resumen.csv', rows);
    }

    // Reportes: wiring de filtros, rango personalizado y exportaciones
    function setupReportFilters(){
      const periodSel = document.getElementById('rep-period-select');
      const typeSel = document.getElementById('rep-filter-type');
      const paySel = document.getElementById('rep-filter-pay');
      const startInp = document.getElementById('rep-date-start');
      const endInp = document.getElementById('rep-date-end');
      const customBox = document.getElementById('rep-custom-range');
      const toggleCustom = ()=>{
        if(!periodSel || !customBox) return;
        const show = periodSel.value==='custom';
        customBox.classList.toggle('hidden', !show);
      };
      periodSel?.addEventListener('change', ()=>{ toggleCustom(); renderCharts(); });
      typeSel?.addEventListener('change', renderCharts);
      paySel?.addEventListener('change', renderCharts);
      startInp?.addEventListener('change', renderCharts);
      endInp?.addEventListener('change', renderCharts);
      // Export buttons
      document.getElementById('rep-export-sales')?.addEventListener('click', exportSalesCSV);
      document.getElementById('rep-export-products')?.addEventListener('click', exportProductsCSV);
      document.getElementById('rep-export-summary')?.addEventListener('click', exportSummaryCSV);
      // Estado inicial
      toggleCustom();
    }

    // Render global: tablas, dashboard, selects
    function renderAll(){
      // POS clientes
      const sel = document.getElementById('pos-customer-select');
      if(sel){
        sel.innerHTML = '';
        const optGen = document.createElement('option'); optGen.value=''; optGen.textContent='Cliente General'; sel.appendChild(optGen);
        appState.clientes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nombre; sel.appendChild(o); });
      }
      // Heurística de categorías para productos sin categoria
      try{
        (appState.productos||[]).forEach(p=>{
          if(p.categoria) return;
          const n = (p.nombre||'').toLowerCase();
          if(n.includes('hamburguesa')) p.categoria='Hamburguesas';
          else if(n.includes('hot dog')||n.includes('hotdog')) p.categoria='Hotdogs';
          else if(n.includes('papa')||n.includes('aros')) p.categoria='Complementos';
          else if(n.includes('pastel')||n.includes('rebanada')||n.includes('chesscake')||n.includes('cheesecake')) p.categoria='Postres';
          else if(n.includes('coca')||n.includes('agua')||n.includes('refresco')||n.includes('bebida')) p.categoria='Bebidas';
        });
      }catch(_){ }
      updateDashboard();
      renderProductosTabla();
      renderIngredientesTabla();
      renderClientesTabla();
      renderVentasTabla();
  renderInsumosView();
    }

    // Auth opcional
    async function initializeAuth(){
      try{
        // Esperar a que Firebase esté listo (los <script type="module"> pueden tardar en móviles/red lenta)
        let tries = 0;
        while((!window.auth || !window.firebaseModules || !window.firebaseModules.onAuthStateChanged) && tries < 80){
          await new Promise(r=>setTimeout(r,150));
          tries++;
        }
        if(!window.auth || !window.firebaseModules){
          console.warn('[Auth] Firebase aún no está listo. Revisa que abras la URL correcta y la conexión.');
          return;
        }
        const { signInAnonymously, onAuthStateChanged } = window.firebaseModules;
        onAuthStateChanged(window.auth, (user)=>{
          const el = document.getElementById('user-id-display');
          const badge = document.getElementById('user-id-badge');
          const authControls = document.getElementById('auth-controls');
          const authStatus = document.getElementById('auth-status-card');
          const emailOut = document.getElementById('auth-status-email');
          const uidOut = document.getElementById('auth-status-uid');
          if(user){
            el && (el.textContent = user.uid);
            badge && (badge.textContent = 'UID: '+user.uid.slice(0,8));
            // Toggle UI: show status card if not anonymous
            const isLinked = !user.isAnonymous;
            if(isLinked){
              authControls && authControls.classList.add('hidden');
              authStatus && authStatus.classList.remove('hidden');
              if(emailOut) emailOut.textContent = user.email || '(sin correo)';
              if(uidOut) uidOut.textContent = user.uid.slice(0,10)+'…';
            } else {
              authControls && authControls.classList.remove('hidden');
              authStatus && authStatus.classList.add('hidden');
              if(emailOut) emailOut.textContent = '';
              if(uidOut) uidOut.textContent = '';
            }
          } else {
            el && (el.textContent = 'Anónimo');
            badge && (badge.textContent = 'UID: —');
            authControls && authControls.classList.remove('hidden');
            authStatus && authStatus.classList.add('hidden');
            if(emailOut) emailOut.textContent = '';
            if(uidOut) uidOut.textContent = '';
            // Asegura sesión anónima tras cerrar sesión
            try{ signInAnonymously(window.auth); }catch(_){ }
          }
          // Reiniciar suscripción cuando el usuario esté listo o cambie
          if(typeof unsubscribeProducts === 'function' && unsubscribeProducts){ try{ unsubscribeProducts(); }catch(_){}
            unsubscribeProducts = null; }
      if(typeof unsubscribeIngredientes === 'function' && unsubscribeIngredientes){ try{ unsubscribeIngredientes(); }catch(_){ } unsubscribeIngredientes = null; }
      if(typeof unsubscribeClientes === 'function' && unsubscribeClientes){ try{ unsubscribeClientes(); }catch(_){ } unsubscribeClientes = null; }
      if(typeof unsubscribeVentas === 'function' && unsubscribeVentas){ try{ unsubscribeVentas(); }catch(_){ } unsubscribeVentas = null; }
          if(typeof unsubscribeCompras === 'function' && unsubscribeCompras){ try{ unsubscribeCompras(); }catch(_){ } unsubscribeCompras = null; }
          if(typeof unsubscribeInsumos === 'function' && unsubscribeInsumos){ try{ unsubscribeInsumos(); }catch(_){ } unsubscribeInsumos = null; }
          if(typeof unsubscribePedidos === 'function' && unsubscribePedidos){ try{ unsubscribePedidos(); }catch(_){ } unsubscribePedidos = null; }
          if(typeof unsubscribeMeta === 'function' && unsubscribeMeta){ try{ unsubscribeMeta(); }catch(_){ } unsubscribeMeta = null; }
      if(typeof startFirestoreAllSync==='function') startFirestoreAllSync(); else startFirestoreProductSync?.();
          // Asegurar los productos solicitados tras cambios de sesión/sync (solo si ya sincronizamos con Firestore para evitar duplicados)
          const guard = ()=>{ try{ if(window.__productsSynced){
            ensureRequestedProducts();
            ensureHamburguesaDobleRecipe();
            ensureHamburguesaBBQRecipe();
            ensureHamburguesaBBQDobleRecipe();
            ensurePapasGajoComplementoRecipe();
            ensurePapasFrancesasComplementoRecipe();
            ensurePapasGajoMedianasRecipe();
            ensurePapasFrancesasMedianasRecipe();
            ensurePapasFrancesasGrandesRecipe();
            ensurePapasGajoGrandesRecipe();
            ensureHotdogJumboRecipe();
            ensureHotdogSalchirojaRecipe();
          } else { setTimeout(guard, 300); } }catch(_){ } };
          setTimeout(guard, 300);
          // Si después de un rato no hay productos (p.ej. móvil nuevo), mantener locales
          setTimeout(()=>{
            try{
              if(!Array.isArray(appState.productos) || appState.productos.length===0){
                console.info('[INIT] No hay productos tras auth; aplicando seed local de seguridad');
                seedIfEmpty();
                renderAll();
                renderPosProductList();
              }
            }catch(_){ }
          }, 2600);
        });
        // Iniciar sesión anónima tras instalar el listener (si aún no hay usuario)
        try{
          if(!window.auth.currentUser){ await signInAnonymously(window.auth); }
        }catch(_){ }
      }catch(e){ console.warn('Auth opcional no disponible', e); }
    }

    // Simple auth UI wiring (email/password). If user is anonymous, we link the account to preserve UID.
  function setupAuthUI(){
      const emailEl = document.getElementById('auth-email');
      const passEl = document.getElementById('auth-pass');
      const btnLogin = document.getElementById('btn-login');
      const btnSignup = document.getElementById('btn-signup');
      const btnLogout = document.getElementById('btn-logout');
  // Prefill email if already logged
  try{ const u = window.auth?.currentUser; if(u?.email && emailEl){ emailEl.value = u.email; } }catch(_){ }
      let M = window.firebaseModules;
      if(!M || !M.createUserWithEmailAndPassword || !M.signInWithEmailAndPassword){
        console.warn('[Auth] Firebase modules no disponibles aún. Esperando…');
        // Reintentos un poco más generosos para móviles
        let tries = 0; const t = setInterval(()=>{
          tries++;
          M = window.firebaseModules;
          if(M && M.createUserWithEmailAndPassword && M.signInWithEmailAndPassword){
            clearInterval(t);
          }
          if(tries>60) clearInterval(t);
        }, 200);
      }
    btnLogin?.addEventListener('click', async ()=>{
        try{
          const M = window.firebaseModules || {};
          if(!M.signInWithEmailAndPassword){
            alert('Firebase Auth no está cargado aún. Recarga la página (Ctrl+F5) y asegúrate de abrir la URL correcta.');
            return;
          }
          const email=(emailEl?.value||'').trim(); const pass=(passEl?.value||'').trim(); if(!email||!pass){ alert('Ingresa email y contraseña'); return; }
      // Inicio de sesión siempre: si la cuenta existe en Firebae, esto usará el mismo UID en todos los dispositivos.
    await M.signInWithEmailAndPassword(window.auth, email, pass);
      alert('Sesión iniciada');
      // Forzar un pequeño refresh de UI por si el evento tarda
      try{ initializeAuth(); }catch(_){ }
        }catch(err){
          console.warn('login', err);
          const code = err?.code||'';
          if(code==='auth/operation-not-allowed'){
            alert(`Inicio de sesión deshabilitado o dominio no autorizado. En Firebase Console → Authentication:
1) Sign-in method: habilita Email/Password
2) Settings → Authorized domains: agrega "${location.hostname}"`);
          } else if(code==='auth/invalid-credential' || code==='auth/wrong-password'){
            alert('Credenciales inválidas. Verifica email y contraseña.');
          } else if(code==='auth/user-not-found'){
            alert('Usuario no encontrado. Presiona "Crear cuenta" para registrarte (si estás anónimo se vinculará y conservarás tus datos).');
          } else if(code==='auth/network-request-failed'){
            alert('Fallo de red. Revisa tu conexión a Internet.');
          } else {
            alert('No se pudo iniciar sesión: '+(err?.message||''));
          }
        }
      });
      btnSignup?.addEventListener('click', async ()=>{
        try{
          const M = window.firebaseModules || {};
          if(!M.createUserWithEmailAndPassword){
            alert('Firebase Auth no está cargado aún. Recarga la página (Ctrl+F5) y asegúrate de abrir la URL correcta.');
            return;
          }
          const email=(emailEl?.value||'').trim(); const pass=(passEl?.value||'').trim(); if(!email||!pass){ alert('Ingresa email y contraseña'); return; }
          const user = window.auth.currentUser;
          if(user && user.isAnonymous && M?.EmailAuthProvider && M?.linkWithCredential){
            const cred = M.EmailAuthProvider.credential(email, pass);
            await M.linkWithCredential(user, cred);
          } else {
            await M.createUserWithEmailAndPassword(window.auth, email, pass);
          }
          alert('Cuenta creada. Tus datos quedarán asociados a esta cuenta.');
          try{ initializeAuth(); }catch(_){ }
        }catch(err){
          console.warn('signup', err);
          const code = err?.code||'';
          if(code==='auth/operation-not-allowed'){
            alert(`Proveedor deshabilitado o dominio no autorizado. En Firebase Console → Authentication:
1) Sign-in method: habilita Email/Password
2) Settings → Authorized domains: agrega "${location.hostname}"`);
          } else if(code==='auth/email-already-in-use'){
            alert('Ese email ya está en uso. Inicia sesión en lugar de registrarte.');
          } else if(code==='auth/weak-password'){
            alert('Contraseña débil. Usa al menos 6 caracteres.');
          } else if(code==='auth/network-request-failed'){
            alert('Fallo de red. Revisa tu conexión a Internet.');
          } else {
            alert('No se pudo crear la cuenta: '+(err?.message||''));
          }
        }
      });
      btnLogout?.addEventListener('click', async ()=>{
  try{ const M = window.firebaseModules || {}; await (M.signOut? M.signOut(window.auth): Promise.resolve()); alert('Sesión cerrada'); try{ initializeAuth(); }catch(_){ } }catch(err){ console.warn('logout', err); }
      });
    }

    // Datos demo
    function seedIfEmpty(){
      // Productos demo
      if(appState.productos.length===0){ appState.productos=[ {id:'p_burger_clas',nombre:'Hamburguesa Clásica',precio:85,descripcion:'Carne 100% res, queso y vegetales frescos'}, {id:'p_burger_bacon',nombre:'Hamburguesa con Tocino',precio:95,descripcion:'Con crujiente tocino y queso'}, {id:'p_papas',nombre:'Papas Fritas',precio:45,descripcion:'Crocantes y doradas'} ]; }
      // Cliente general
      if(appState.clientes.length===0){ appState.clientes=[ {id:'cli_general',nombre:'Cliente General',telefono:'',direccion:'',puntos:0,gastoTotal:0} ]; }
      // Ingredientes predefinidos (sólo si está vacío)
      if((!Array.isArray(appState.ingredientes) || appState.ingredientes.length===0) && PRESET_INGREDIENTS.length>0){
        appState.ingredientes = PRESET_INGREDIENTS.map((i)=>({ id: generateId('ing'), ...i }));
        console.log('[SEED] Ingredientes precargados:', appState.ingredientes.length);
      }
      // Persistir después de seed
      saveLS();
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      console.log('[INIT] DOMContentLoaded');
      setTimeout(hideLoading, 2000);
      loadLS();
      sanitizeState();
  assignSaleNumbersIfMissing();
      console.log('[INIT] Post-loadLS', {
        productos: appState.productos?.length||0,
        ingredientes: appState.ingredientes?.length||0,
        clientes: appState.clientes?.length||0
      });
      seedIfEmpty();
      console.log('[INIT] Post-seed', {
        productos: appState.productos?.length||0,
        ingredientes: appState.ingredientes?.length||0,
        clientes: appState.clientes?.length||0
      });
  // Merge silencioso de la lista proporcionada para asegurar que aparezcan en Ingredientes
  importPresetIngredientsSilently();
  // Merge silencioso de clientes proporcionados por el usuario
  importUserClientsPresetSilently();
      // Crear/actualizar Hamburguesa Clásica con receta indicada
      addOrUpdateProductWithRecipe({
        nombre: 'Hamburguesa Clásica',
        precio: 85,
        descripcion: 'Clásica con tocino, manchego, americano, vegetales y salsas',
        receta: [
          { nombre:'QUESO MANCHEGO', cantidad: 30 }, // g
          { nombre:'TOCINO', cantidad: 1 },
          { nombre:'Vegetales', cantidad: 1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad: 1 },
          { nombre:'MAYONESA', cantidad: 10 }, // g
          { nombre:'QUESO AMERICANO', cantidad: 1 },
          { nombre:'CHAROLA UNISEL', cantidad: 1 },
          { nombre:'BOTECITO', cantidad: 1 },
          { nombre:'CHILES', cantidad: 1 },
          { nombre:'BIMBOLLO', cantidad: 1 }
        ]
      });
      // Crear/actualizar Hamburguesa Doble con receta indicada
      addOrUpdateProductWithRecipe({
        nombre: 'Hamburguesa Doble',
        precio: 115, // estimado para mantener margen similar a la clásica
        descripcion: 'Doble carne, quesos y vegetales',
        receta: [
          { nombre:'QUESO MANCHEGO', cantidad: 50 }, // g
          { nombre:'TOCINO', cantidad: 1 },
          { nombre:'Vegetales', cantidad: 1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad: 2 },
          { nombre:'MAYONESA', cantidad: 10 }, // g
          { nombre:'QUESO AMERICANO', cantidad: 1 },
          { nombre:'CHAROLA UNISEL', cantidad: 1 },
          { nombre:'BOTECITO', cantidad: 1 },
          { nombre:'CHILES', cantidad: 1 },
          { nombre:'BIMBOLLO', cantidad: 1 }
        ]
      });
  // Asegurar productos solicitados
  ensureRequestedProducts();
  setupSidebar();
      setupNavigation();
  // Dashboard period change
  document.getElementById('db-period-select')?.addEventListener('change', updateDashboard);
  document.getElementById('rep-period-select')?.addEventListener('change', renderCharts);
  setupReportFilters();
      wirePosInputs();
      setupCreateButtons();
      setupIngredientesActions();
  setupProductosActions();
  // Precalcular insumos desde ventas existentes (después de cargar/sembrar datos)
  recomputeInsumosFromVentas();
      // Aplicar receta solicitada para HAMBURGUESA DOBLE (si ingredientes están presentes)
      updateProductRecipeExact({
        nombre:'HAMBURGUESA DOBLE',
        precio:130,
        descripcion:'Hamburguesa doble carne con queso manchego, tocino y vegetales.',
        receta:[
          { nombre:'QUESO MANCHEGO', cantidad:50 },
          { nombre:'TOCINO', cantidad:1 },
          { nombre:'Vegetales', cantidad:1 },
          { nombre:'CARNE DE HAMBURGUESA', cantidad:2 },
          { nombre:'MAYONESA', cantidad:10 },
          { nombre:'QUESO AMERICANO', cantidad:1 },
          { nombre:'CHAROLA UNISEL', cantidad:1 },
          { nombre:'BOTECITO', cantidad:1 },
          { nombre:'CHILES', cantidad:1 },
          { nombre:'BIMBOLLO', cantidad:1 }
        ]
      });
  ensureHamburguesaDobleRecipe();
  ensureHamburguesaBBQRecipe();
  ensureHamburguesaBBQDobleRecipe();
  ensurePapasGajoComplementoRecipe();
  ensurePapasFrancesasComplementoRecipe();
  ensurePapasGajoMedianasRecipe();
  ensurePapasFrancesasMedianasRecipe();
  ensurePapasGajoGrandesRecipe();
  ensurePapasFrancesasGrandesRecipe();
  ensureHotdogJumboRecipe();
  ensureHotdogSalchirojaRecipe();
      renderAll();
      renderPosProductList();
      renderPedidosPendientes();
      renderCharts();
      initializeAuth();
  setupAuthUI();
  // Iniciar sincronización de productos a Firestore (si disponible)
  startFirestoreProductSync?.();
  if(typeof startFirestoreAllSync==='function') startFirestoreAllSync();
      // Show Firebase project info for quick diagnostics
      try{
        const ind = document.getElementById('firebase-project-indicator');
        if(ind && window.firebaseConfig){
          ind.textContent = `${window.firebaseConfig.projectId || '—'} • ${window.firebaseConfig.authDomain || ''}`;
        }
      }catch(_){ }
      // Wire backup/restore
      document.getElementById('btn-backup')?.addEventListener('click', backupData);
      document.getElementById('btn-restore')?.addEventListener('click', ()=> document.getElementById('restore-file-input')?.click());
      document.getElementById('restore-file-input')?.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return; restoreDataFromFile(f); e.target.value = '';
      });
      hideLoading();
    });

    // Bootstrap global de navegación (respaldo independiente)
    (function(){
      if(window.__navBootstrap) return; // evitar duplicado
      window.__navBootstrap = true;
      const go = ()=>{
        try{
          const id = (location.hash||'#dashboard').replace('#','');
          const exists = document.getElementById('view-'+id);
          if(exists){ showView(id); }
        }catch(e){ console.warn('nav bootstrap go', e); }
      };
      window.addEventListener('hashchange', go);
      document.addEventListener('click', (e)=>{
        const link = e.target.closest && e.target.closest('a.nav-link');
        if(!link) return;
        e.preventDefault();
        const id = (link.getAttribute('href')||'').replace('#','');
        if(id) showView(id);
      }, { capture:true });
      // inicial
      go();
    })();
  </script>
  <script>
    // ===== Backup / Restore =====
    function backupData(){
      try{
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          origin: location.origin,
          uid: window.auth?.currentUser?.uid || null,
          appState
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
        const ts = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const name = `sr-sra-burger-backup-${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}-${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.json`;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){ console.warn('backupData', e); alert('No se pudo generar el respaldo.'); }
    }

    function restoreDataFromFile(file){
      try{
        const reader = new FileReader();
        reader.onload = async ()=>{
          try{
            const json = JSON.parse(reader.result);
            const src = json.appState || json; // permitir archivo con o sin contenedor
            if(!src || typeof src !== 'object'){ alert('Archivo inválido'); return; }
            if(!confirm('Esto reemplazará los datos locales (productos, ingredientes, clientes, ventas, etc.). ¿Continuar?')) return;
            // Reemplazo explícito por claves conocidas
            const pickArr = (arr)=> Array.isArray(arr) ? arr : [];
            const pickObj = (obj, def)=> obj && typeof obj==='object' ? obj : (def||{});
            appState.productos = pickArr(src.productos);
            appState.ingredientes = pickArr(src.ingredientes);
            appState.clientes = pickArr(src.clientes);
            appState.ventas = pickArr(src.ventas);
            appState.pedidosPendientes = pickArr(src.pedidosPendientes);
            appState.insumosConsumo = pickObj(src.insumosConsumo, { totales:{}, historial:[], merma:[] });
            appState.inventario = pickObj(src.inventario, { compras:[] });
            appState.nextSaleNumber = Number(src.nextSaleNumber)||1;
            // Post import housekeeping
            try{ assignSaleNumbersIfMissing(); }catch(_){ }
            try{ recomputeInsumosFromVentas(); }catch(_){ }
            saveLS();
            renderAll(); renderPosProductList(); renderPedidosPendientes();
            // Subir productos a Firestore si está disponible
            if(Array.isArray(appState.productos) && typeof saveProductToFirestore==='function'){
              for(const p of appState.productos){ try{ await saveProductToFirestore(p); }catch(_){ } }
            }
            if(Array.isArray(appState.ingredientes) && typeof saveIngredientToFirestore==='function'){
              for(const i of appState.ingredientes){ try{ await saveIngredientToFirestore(i); }catch(_){ } }
            }
            if(Array.isArray(appState.clientes) && typeof saveClienteToFirestore==='function'){
              for(const c of appState.clientes){ try{ await saveClienteToFirestore(c); }catch(_){ } }
            }
            if(Array.isArray(appState.ventas) && typeof saveVentaToFirestore==='function'){
              for(const v of appState.ventas){ try{ await saveVentaToFirestore(v); }catch(_){ } }
            }
            alert('✅ Datos restaurados.');
          }catch(e){ console.warn('restore parse', e); alert('Archivo de respaldo inválido.'); }
        };
        reader.onerror = ()=> alert('No se pudo leer el archivo.');
        reader.readAsText(file);
      }catch(e){ console.warn('restoreDataFromFile', e); alert('No se pudo restaurar.'); }
    }
  </script>
</body>
</html>
